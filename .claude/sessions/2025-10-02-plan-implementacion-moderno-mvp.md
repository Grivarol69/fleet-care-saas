# Plan de Implementaci√≥n Moderno - MVP Fleet Care SaaS

## Sesi√≥n: 02 Octubre 2025
**Contexto**: Plan de implementaci√≥n usando patrones modernos (Hooks, TanStack Query, Zustand) sin clases de React

---

## üéØ OBJETIVO PRINCIPAL

Completar MVP en **7.5 sprints (15 semanas)** usando:
- ‚úÖ **React Hooks** (componentes funcionales, sin clases)
- ‚úÖ **TanStack Query** (data fetching, cache, sincronizaci√≥n)
- ‚úÖ **Zustand** (estado global ligero)
- ‚úÖ **Custom Hooks** (l√≥gica reutilizable)
- ‚úÖ **Service Layer** (backend/frontend separation)
- ‚úÖ **Repository Pattern** (acceso a datos)

---

## üìä GAP ANALYSIS (Estado Actual)

| M√≥dulo | Completado | Faltante | Prioridad | Sprints |
|--------|------------|----------|-----------|---------|
| Gesti√≥n Activos | 70% | Categories, history | LOW | 1 |
| √ìrdenes Trabajo | 40% | UI completa, assignment | **HIGH** | 2 |
| Preventivo | 85% | Auto-gen workflow | LOW | 0.5 |
| Inventario | 15% | Stock system, UI | **HIGH** | 2 |
| Dashboard | 25% | M√©tricas, exports | MEDIUM | 1.5 |
| Usuarios | 90% | Role-based UI | LOW | 0.5 |

**Total MVP**: 7.5 sprints = 15 semanas

---

## üèóÔ∏è ARQUITECTURA MODERNA PROPUESTA

### Stack de Frontend
```
UI Layer
‚îú‚îÄ‚îÄ Components (Shadcn + Custom)
‚îú‚îÄ‚îÄ Pages (Next.js App Router)
‚îî‚îÄ‚îÄ Hooks (Custom + TanStack Query)

State Management
‚îú‚îÄ‚îÄ TanStack Query (Server State)
‚îú‚îÄ‚îÄ Zustand (Client State)
‚îî‚îÄ‚îÄ React Context (Theme, Auth)

Data Layer
‚îú‚îÄ‚îÄ API Routes (Next.js)
‚îú‚îÄ‚îÄ Service Layer (Business Logic)
‚îî‚îÄ‚îÄ Repository Layer (Prisma)
```

### Patrones Modernos vs Propuesta Original

| Patr√≥n Original | Patr√≥n Moderno | Justificaci√≥n |
|----------------|----------------|---------------|
| ‚ùå ErrorBoundary (class) | ‚úÖ Error handling con TanStack Query | Hooks nativos, mejor DX |
| ‚ùå Singleton class | ‚úÖ Zustand store | Lightweight, hooks-based |
| ‚ùå Observer class | ‚úÖ TanStack Query + useEffect | Cacheo autom√°tico, optimistic updates |
| ‚úÖ Repository Pattern | ‚úÖ Repository Pattern | Backend pattern, mantener |
| ‚úÖ Service Layer | ‚úÖ Service Layer | Backend pattern, mantener |
| ‚ùå Class-based forms | ‚úÖ React Hook Form + Zod | Ya lo usas, perfecto |

---

## üöÄ IMPLEMENTACI√ìN POR SPRINTS

### SPRINT 1 (Semanas 1-2): FOUNDATION MODERNA

**Goal**: Establecer infraestructura moderna sin romper c√≥digo existente

#### Week 1: Setup Infraestructura
```bash
# Instalar dependencias
npm install @tanstack/react-query zustand
npm install -D @tanstack/react-query-devtools
```

**Tasks**:
1. **Setup TanStack Query**
   ```typescript
   // src/lib/providers/QueryProvider.tsx
   'use client';
   import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
   import { ReactQueryDevtools } from '@tanstack/react-query-devtools';
   import { useState } from 'react';

   export function QueryProvider({ children }: { children: React.ReactNode }) {
     const [queryClient] = useState(() => new QueryClient({
       defaultOptions: {
         queries: {
           staleTime: 60 * 1000, // 1 minuto
           refetchOnWindowFocus: false,
         },
       },
     }));

     return (
       <QueryClientProvider client={queryClient}>
         {children}
         <ReactQueryDevtools initialIsOpen={false} />
       </QueryClientProvider>
     );
   }
   ```

2. **Setup Zustand Store (Estado Global)**
   ```typescript
   // src/stores/useAppStore.ts
   import { create } from 'zustand';
   import { devtools, persist } from 'zustand/middleware';

   interface AppState {
     // UI State
     sidebarOpen: boolean;
     toggleSidebar: () => void;

     // Feature Flags
     features: {
       newWorkOrderUI: boolean;
       enhancedInventory: boolean;
       advancedReporting: boolean;
     };
     toggleFeature: (feature: keyof AppState['features']) => void;
   }

   export const useAppStore = create<AppState>()(
     devtools(
       persist(
         (set) => ({
           sidebarOpen: true,
           toggleSidebar: () => set((state) => ({
             sidebarOpen: !state.sidebarOpen
           })),

           features: {
             newWorkOrderUI: false,
             enhancedInventory: false,
             advancedReporting: false,
           },
           toggleFeature: (feature) => set((state) => ({
             features: {
               ...state.features,
               [feature]: !state.features[feature],
             },
           })),
         }),
         { name: 'app-store' }
       )
     )
   );
   ```

3. **Crear Service Layer Foundation**
   ```typescript
   // src/lib/services/base.service.ts
   import axios, { AxiosInstance } from 'axios';

   export class BaseService {
     protected api: AxiosInstance;

     constructor() {
       this.api = axios.create({
         baseURL: '/api',
         headers: {
           'Content-Type': 'application/json',
         },
       });

       // Interceptor para errores globales
       this.api.interceptors.response.use(
         (response) => response,
         (error) => {
           // Logging centralizado
           console.error('API Error:', error);
           return Promise.reject(error);
         }
       );
     }
   }
   ```

4. **Crear Repository Pattern Foundation**
   ```typescript
   // src/lib/repositories/base.repository.ts
   import { PrismaClient } from '@prisma/client';

   export class BaseRepository {
     protected prisma: PrismaClient;

     constructor() {
       this.prisma = new PrismaClient();
     }

     protected handleError(error: unknown): never {
       console.error('Repository Error:', error);
       throw error;
     }
   }
   ```

#### Week 2: Service Layer para Vehicles

**Tasks**:
1. **Vehicle Service (L√≥gica de Negocio)**
   ```typescript
   // src/lib/services/vehicle.service.ts
   import { BaseService } from './base.service';
   import type { Vehicle } from '@prisma/client';

   export interface CreateVehicleDto {
     licensePlate: string;
     make: string;
     model: string;
     year: number;
     vehicleBrandId: number;
     vehicleLineId: number;
   }

   export interface VehicleWithMetrics extends Vehicle {
     currentKm: number;
     maintenanceStatus: 'OK' | 'DUE' | 'OVERDUE';
     lastMaintenanceDate?: Date;
   }

   class VehicleServiceClass extends BaseService {
     async getAll(): Promise<VehicleWithMetrics[]> {
       const response = await this.api.get<Vehicle[]>('/vehicles/vehicles');

       // Enriquecer con m√©tricas (l√≥gica de negocio)
       return response.data.map(vehicle => ({
         ...vehicle,
         currentKm: this.calculateCurrentKm(vehicle),
         maintenanceStatus: this.calculateMaintenanceStatus(vehicle),
       }));
     }

     async getById(id: number): Promise<VehicleWithMetrics> {
       const response = await this.api.get<Vehicle>(`/vehicles/vehicles/${id}`);
       return {
         ...response.data,
         currentKm: this.calculateCurrentKm(response.data),
         maintenanceStatus: this.calculateMaintenanceStatus(response.data),
       };
     }

     async create(data: CreateVehicleDto): Promise<Vehicle> {
       const response = await this.api.post<Vehicle>('/vehicles/vehicles', data);
       return response.data;
     }

     async update(id: number, data: Partial<CreateVehicleDto>): Promise<Vehicle> {
       const response = await this.api.put<Vehicle>(`/vehicles/vehicles/${id}`, data);
       return response.data;
     }

     async delete(id: number): Promise<void> {
       await this.api.delete(`/vehicles/vehicles/${id}`);
     }

     // L√≥gica de negocio privada
     private calculateCurrentKm(vehicle: any): number {
       // Implementar c√°lculo real
       return 0;
     }

     private calculateMaintenanceStatus(vehicle: any): 'OK' | 'DUE' | 'OVERDUE' {
       // Implementar l√≥gica real
       return 'OK';
     }
   }

   // Export singleton
   export const vehicleService = new VehicleServiceClass();
   ```

2. **Custom Hooks con TanStack Query**
   ```typescript
   // src/hooks/useVehicles.ts
   import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
   import { vehicleService, type CreateVehicleDto, type VehicleWithMetrics } from '@/lib/services/vehicle.service';
   import { toast } from 'sonner';

   const QUERY_KEY = ['vehicles'] as const;

   // Query: Get all vehicles
   export function useVehicles() {
     return useQuery({
       queryKey: QUERY_KEY,
       queryFn: () => vehicleService.getAll(),
     });
   }

   // Query: Get single vehicle
   export function useVehicle(id: number) {
     return useQuery({
       queryKey: [...QUERY_KEY, id],
       queryFn: () => vehicleService.getById(id),
       enabled: !!id, // Solo fetch si hay ID
     });
   }

   // Mutation: Create vehicle
   export function useCreateVehicle() {
     const queryClient = useQueryClient();

     return useMutation({
       mutationFn: (data: CreateVehicleDto) => vehicleService.create(data),
       onSuccess: () => {
         queryClient.invalidateQueries({ queryKey: QUERY_KEY });
         toast.success('Veh√≠culo creado exitosamente');
       },
       onError: (error: any) => {
         toast.error(error.message || 'Error al crear veh√≠culo');
       },
     });
   }

   // Mutation: Update vehicle
   export function useUpdateVehicle() {
     const queryClient = useQueryClient();

     return useMutation({
       mutationFn: ({ id, data }: { id: number; data: Partial<CreateVehicleDto> }) =>
         vehicleService.update(id, data),
       onSuccess: (_, variables) => {
         queryClient.invalidateQueries({ queryKey: QUERY_KEY });
         queryClient.invalidateQueries({ queryKey: [...QUERY_KEY, variables.id] });
         toast.success('Veh√≠culo actualizado exitosamente');
       },
       onError: (error: any) => {
         toast.error(error.message || 'Error al actualizar veh√≠culo');
       },
     });
   }

   // Mutation: Delete vehicle
   export function useDeleteVehicle() {
     const queryClient = useQueryClient();

     return useMutation({
       mutationFn: (id: number) => vehicleService.delete(id),
       onSuccess: () => {
         queryClient.invalidateQueries({ queryKey: QUERY_KEY });
         toast.success('Veh√≠culo eliminado exitosamente');
       },
       onError: (error: any) => {
         toast.error(error.message || 'Error al eliminar veh√≠culo');
       },
     });
   }
   ```

3. **Uso en Componentes**
   ```tsx
   // src/app/dashboard/vehicles/page.tsx
   'use client';
   import { useVehicles, useDeleteVehicle } from '@/hooks/useVehicles';
   import { Button } from '@/components/ui/button';
   import { Loader2 } from 'lucide-react';

   export default function VehiclesPage() {
     const { data: vehicles, isLoading, error } = useVehicles();
     const deleteMutation = useDeleteVehicle();

     if (isLoading) {
       return <div className="flex justify-center p-8">
         <Loader2 className="animate-spin" />
       </div>;
     }

     if (error) {
       return <div className="text-red-600 p-4">
         Error al cargar veh√≠culos: {error.message}
       </div>;
     }

     const handleDelete = async (id: number) => {
       if (confirm('¬øEst√°s seguro de eliminar este veh√≠culo?')) {
         deleteMutation.mutate(id);
       }
     };

     return (
       <div>
         <h1>Veh√≠culos</h1>
         <div className="grid gap-4">
           {vehicles?.map(vehicle => (
             <div key={vehicle.id} className="border p-4 rounded">
               <h3>{vehicle.licensePlate}</h3>
               <p>KM Actual: {vehicle.currentKm}</p>
               <p>Estado: {vehicle.maintenanceStatus}</p>
               <Button
                 onClick={() => handleDelete(vehicle.id)}
                 variant="destructive"
                 disabled={deleteMutation.isPending}
               >
                 {deleteMutation.isPending ? 'Eliminando...' : 'Eliminar'}
               </Button>
             </div>
           ))}
         </div>
       </div>
     );
   }
   ```

**Deliverables Sprint 1**:
- ‚úÖ TanStack Query configurado
- ‚úÖ Zustand store para UI state
- ‚úÖ Vehicle Service + Repository
- ‚úÖ Custom hooks modernos (useVehicles)
- ‚úÖ Error handling centralizado
- ‚úÖ Feature flags system

---

### SPRINT 2 (Semanas 3-4): WORK ORDERS MVP

**Goal**: Sistema completo de √≥rdenes de trabajo correctivas

#### User Stories

**US-1: Como Admin quiero crear √≥rdenes de trabajo**
```typescript
// src/lib/services/workorder.service.ts
import { BaseService } from './base.service';

export interface CreateWorkOrderDto {
  vehicleId: number;
  description: string;
  priority: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';
  scheduledDate: Date;
  assignedToId?: number;
  estimatedCost?: number;
}

class WorkOrderServiceClass extends BaseService {
  async getAll() {
    const response = await this.api.get('/maintenance/work-orders');
    return response.data;
  }

  async create(data: CreateWorkOrderDto) {
    const response = await this.api.post('/maintenance/work-orders', data);
    return response.data;
  }

  async assign(workOrderId: number, technicianId: number) {
    const response = await this.api.patch(`/maintenance/work-orders/${workOrderId}/assign`, {
      technicianId,
    });
    return response.data;
  }

  async updateStatus(workOrderId: number, status: string) {
    const response = await this.api.patch(`/maintenance/work-orders/${workOrderId}/status`, {
      status,
    });
    return response.data;
  }
}

export const workOrderService = new WorkOrderServiceClass();
```

```typescript
// src/hooks/useWorkOrders.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { workOrderService } from '@/lib/services/workorder.service';

const QUERY_KEY = ['work-orders'] as const;

export function useWorkOrders() {
  return useQuery({
    queryKey: QUERY_KEY,
    queryFn: () => workOrderService.getAll(),
  });
}

export function useCreateWorkOrder() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: workOrderService.create,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: QUERY_KEY });
    },
  });
}

export function useAssignWorkOrder() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({ workOrderId, technicianId }: { workOrderId: number; technicianId: number }) =>
      workOrderService.assign(workOrderId, technicianId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: QUERY_KEY });
    },
  });
}
```

**US-2: Como T√©cnico quiero ver mis √≥rdenes asignadas**
```typescript
// src/hooks/useMyWorkOrders.ts
export function useMyWorkOrders() {
  const { data: user } = useAuth(); // Tu hook de auth

  return useQuery({
    queryKey: ['work-orders', 'my-orders'],
    queryFn: () => workOrderService.getByTechnician(user.id),
    enabled: !!user,
  });
}
```

**Deliverables Sprint 2**:
- ‚úÖ WorkOrder service + repository
- ‚úÖ Custom hooks (useWorkOrders, useCreateWorkOrder)
- ‚úÖ UI completa CRUD work orders
- ‚úÖ Assignment a t√©cnicos funcional
- ‚úÖ Status workflow (pending ‚Üí in_progress ‚Üí completed)

---

### SPRINT 3 (Semanas 5-6): INVENTORY SYSTEM

**Goal**: Sistema b√°sico de inventario con stock tracking

#### Tasks

1. **Inventory Service**
   ```typescript
   // src/lib/services/inventory.service.ts
   export interface InventoryItem {
     id: number;
     name: string;
     category: string;
     quantity: number;
     minStock: number;
     price: number;
   }

   class InventoryServiceClass extends BaseService {
     async getAll(): Promise<InventoryItem[]> {
       const response = await this.api.get('/inventory/items');
       return response.data;
     }

     async updateStock(itemId: number, quantity: number) {
       const response = await this.api.patch(`/inventory/items/${itemId}/stock`, {
         quantity,
       });
       return response.data;
     }

     async getLowStockItems(): Promise<InventoryItem[]> {
       const response = await this.api.get('/inventory/items?lowStock=true');
       return response.data;
     }
   }

   export const inventoryService = new InventoryServiceClass();
   ```

2. **Inventory Hooks**
   ```typescript
   // src/hooks/useInventory.ts
   export function useInventory() {
     return useQuery({
       queryKey: ['inventory'],
       queryFn: () => inventoryService.getAll(),
     });
   }

   export function useLowStockItems() {
     return useQuery({
       queryKey: ['inventory', 'low-stock'],
       queryFn: () => inventoryService.getLowStockItems(),
       refetchInterval: 30000, // Check cada 30 segundos
     });
   }

   export function useUpdateStock() {
     const queryClient = useQueryClient();

     return useMutation({
       mutationFn: ({ itemId, quantity }: { itemId: number; quantity: number }) =>
         inventoryService.updateStock(itemId, quantity),
       onSuccess: () => {
         queryClient.invalidateQueries({ queryKey: ['inventory'] });
       },
     });
   }
   ```

3. **UI Components**
   - Lista de items con tabla (TanStack Table)
   - Form agregar/editar items
   - Alertas de stock bajo

**Deliverables Sprint 3**:
- ‚úÖ Inventory service + repository
- ‚úÖ Stock tracking functionality
- ‚úÖ Low stock alerts
- ‚úÖ UI completa inventario

---

### SPRINT 4 (Semanas 7-8): DASHBOARD & REPORTING

**Goal**: Dashboard funcional con m√©tricas en tiempo real

#### Tasks

1. **Metrics Service**
   ```typescript
   // src/lib/services/metrics.service.ts
   export interface DashboardMetrics {
     totalVehicles: number;
     activeWorkOrders: number;
     overdueMaintenances: number;
     lowStockItems: number;
     monthlyExpenses: number;
   }

   class MetricsServiceClass extends BaseService {
     async getDashboardMetrics(): Promise<DashboardMetrics> {
       const response = await this.api.get('/metrics/dashboard');
       return response.data;
     }

     async getMaintenanceReport(startDate: Date, endDate: Date) {
       const response = await this.api.get('/reports/maintenance', {
         params: { startDate, endDate },
       });
       return response.data;
     }
   }

   export const metricsService = new MetricsServiceClass();
   ```

2. **Dashboard Hook**
   ```typescript
   // src/hooks/useDashboard.ts
   export function useDashboardMetrics() {
     return useQuery({
       queryKey: ['dashboard', 'metrics'],
       queryFn: () => metricsService.getDashboardMetrics(),
       refetchInterval: 30000, // Actualizar cada 30 segundos
     });
   }
   ```

3. **Dashboard UI**
   ```tsx
   // src/app/dashboard/page.tsx
   export default function DashboardPage() {
     const { data: metrics, isLoading } = useDashboardMetrics();

     if (isLoading) return <DashboardSkeleton />;

     return (
       <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
         <MetricCard
           title="Veh√≠culos Totales"
           value={metrics.totalVehicles}
           icon={<Car />}
         />
         <MetricCard
           title="√ìrdenes Activas"
           value={metrics.activeWorkOrders}
           icon={<Wrench />}
         />
         {/* etc */}
       </div>
     );
   }
   ```

**Deliverables Sprint 4**:
- ‚úÖ Dashboard con m√©tricas en tiempo real
- ‚úÖ Export a PDF/Excel
- ‚úÖ Reportes b√°sicos maintenance

---

## üéØ CONSOLIDACI√ìN FINAL

### SPRINT 5-6: Polish & Testing
- Testing completo con Vitest
- Performance optimization
- Mobile responsiveness
- Documentation

### SPRINT 7-8: Beta Testing & Launch Prep
- User acceptance testing
- Bug fixes
- Production deployment
- Monitoring setup

---

## üìà M√âTRICAS DE √âXITO

### Technical KPIs
- **Code Coverage**: >80%
- **Bundle Size**: <500KB initial load
- **Lighthouse Score**: >90
- **API Response Time**: <200ms p95

### Business KPIs
- **Feature Velocity**: 3-5 stories/sprint
- **Bug Rate**: <2 bugs/story
- **User Satisfaction**: >4.5/5

---

## üö® RISK MITIGATION

### Feature Flags (Zustand)
```typescript
// Rollback inmediato si algo falla
const { features } = useAppStore();

if (features.newWorkOrderUI) {
  return <WorkOrdersV2 />;
}
return <WorkOrdersV1 />; // Legacy
```

### Error Boundaries con react-error-boundary
```bash
npm install react-error-boundary
```

```tsx
import { ErrorBoundary } from 'react-error-boundary';

function ErrorFallback({ error, resetErrorBoundary }) {
  return (
    <div role="alert">
      <p>Something went wrong:</p>
      <pre>{error.message}</pre>
      <button onClick={resetErrorBoundary}>Try again</button>
    </div>
  );
}

<ErrorBoundary FallbackComponent={ErrorFallback}>
  <YourApp />
</ErrorBoundary>
```

---

## üìö STACK TECNOL√ìGICO FINAL

```json
{
  "framework": "Next.js 14 (App Router)",
  "ui": "Shadcn UI + Tailwind CSS",
  "forms": "React Hook Form + Zod",
  "tables": "TanStack Table",
  "state": {
    "server": "TanStack Query",
    "client": "Zustand",
    "auth": "React Context"
  },
  "backend": {
    "database": "Prisma + PostgreSQL",
    "patterns": "Repository + Service Layer"
  },
  "testing": "Vitest + Testing Library",
  "monitoring": "Vercel Analytics + Sentry"
}
```

---

## ‚úÖ PR√ìXIMOS PASOS INMEDIATOS

1. **Hoy**: Aprobar este plan
2. **Ma√±ana**: Setup TanStack Query + Zustand
3. **D√≠as 3-5**: Migrar Vehicle hooks a TanStack Query
4. **Semana 2**: Completar Vehicle Service Layer
5. **Semana 3**: Comenzar Work Orders

---

*Plan actualizado con patrones modernos React 16.8+ (Hooks only)*
*Sin clases, usando TanStack Query + Zustand + Custom Hooks*
