generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ========================================
// MULTI-TENANCY & BILLING CORE
// ========================================

model Tenant {
  id                 String             @id @default(uuid())
  name               String
  slug               String             @unique // Para subdominios
  domain             String?            @unique // Dominio personalizado opcional
  logo               String?
  country            String             @default("CO") // ISO 3166-1 alpha-2
  currency           String             @default("COP") // Moneda local
  
  onboardingStatus   OnboardingStatus   @default(PENDING)
  
  settings           Json? // Configuraciones específicas del tenant
  subscriptionId     String?            @unique
  subscriptionStatus SubscriptionStatus @default(TRIAL)
  trialEndsAt        DateTime?
  billingEmail       String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  // Relaciones
  users                     User[]
  vehicles                  Vehicle[]
  vehicleBrands             VehicleBrand[]
  vehicleLines              VehicleLine[]
  vehicleTypes              VehicleType[]
  mantCategories            MantCategory[]
  mantItems                 MantItem[]
  maintenanceTemplates      MaintenanceTemplate[] // ✅ CURRENT
  vehicleMantPrograms       VehicleMantProgram[] // ✅ CURRENT ARCHITECTURE
  vehicleProgramPackages    VehicleProgramPackage[] // ✅ CURRENT ARCHITECTURE
  vehicleProgramItems       VehicleProgramItem[] // ✅ CURRENT ARCHITECTURE
  workOrders                WorkOrder[]
  technicians               Technician[]
  providers                 Provider[]
  documents                 Document[]
  subscriptions             Subscription[]
  drivers                   Driver[]
  vehicleDrivers            VehicleDriver[]
  maintenanceAlerts         MaintenanceAlert[]
  financialAlerts           FinancialAlert[] // ✅ Nueva relación
  invoices                  Invoice[]
  inventoryItems            InventoryItem[]
  inventoryMovements        InventoryMovement[]
  internalWorkTickets       InternalWorkTicket[]
  documentTypeConfigs       DocumentTypeConfig[]
  purchaseOrders            PurchaseOrder[]
  mantItemRequests          MantItemRequest[]
  mantItemVehicleParts      MantItemVehiclePart[]

  @@index([slug])
  @@index([subscriptionStatus])
}

model User {
  id        String   @id @default(uuid())
  tenantId  String
  email     String
  firstName String?
  lastName  String?
  role      UserRole @default(DRIVER) // Default más restrictivo
  avatar    String?
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relaciones de auditoría - Invoice & MasterParts
  invoicesApproved      Invoice[]          @relation("InvoiceApprover")
  invoicesRegistered    Invoice[]          @relation("InvoiceRegistrar")
  priceHistoryApproved  PartPriceHistory[] @relation("PriceHistoryApprover")
  priceHistoryPurchased PartPriceHistory[] @relation("PriceHistoryPurchaser")
  paymentsRegistered    InvoicePayment[]   @relation("PaymentRegistrar")

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
}

// ========================================
// BILLING & SUBSCRIPTIONS
// ========================================

model Subscription {
  id                    String             @id @default(uuid())
  tenantId              String
  mercadoPagoUserId     String? // ID del usuario en MercadoPago
  preapprovalId         String?            @unique // ID de la suscripción recurrente
  planId                String // ID del plan de precios
  status                SubscriptionStatus
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  cancelAtPeriodEnd     Boolean            @default(false)
  lastPaymentId         String? // Último pago procesado
  failedPaymentAttempts Int                @default(0)
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@index([tenantId])
  @@index([mercadoPagoUserId])
  @@index([preapprovalId])
}

model Payment {
  id             String        @id @default(uuid())
  tenantId       String // Multi-tenant support
  subscriptionId String
  mercadoPagoId  String        @unique // ID del pago en MercadoPago
  amount         Decimal       @db.Decimal(10, 2)
  currency       String        @default("COP") // Peso colombiano
  status         PaymentStatus
  paymentMethod  String? // Tarjeta, PSE, etc.
  description    String?
  failureReason  String?
  processedAt    DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([subscriptionId])
  @@index([mercadoPagoId])
  @@index([status])
}

// ========================================
// VEHICLE MANAGEMENT
// ========================================

model VehicleBrand {
  id        Int      @id @default(autoincrement())
  tenantId  String? // Nullable: NULL = global, populated = tenant-specific
  isGlobal  Boolean  @default(false) // Global Knowledge Base flag
  name      String
  status    Status   @default(ACTIVE) // Soft delete support
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant               Tenant?               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lines                VehicleLine[]
  vehicles             Vehicle[]
  maintenanceTemplates MaintenanceTemplate[] // ✅ CURRENT
  mantItemVehicleParts MantItemVehiclePart[] // KB: repuestos por marca

  @@unique([tenantId, name])
  @@index([isGlobal])
  @@index([status])
}

model VehicleLine {
  id        Int      @id @default(autoincrement())
  tenantId  String? // Nullable: NULL = global, populated = tenant-specific
  isGlobal  Boolean  @default(false) // Global Knowledge Base flag
  name      String
  brandId   Int
  status    Status   @default(ACTIVE) // Soft delete support
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant               Tenant?               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  brand                VehicleBrand          @relation(fields: [brandId], references: [id], onDelete: Cascade)
  vehicles             Vehicle[]
  maintenanceTemplates MaintenanceTemplate[] // ✅ CURRENT
  mantItemVehicleParts MantItemVehiclePart[] // KB: repuestos por línea

  @@unique([tenantId, brandId, name])
  @@index([brandId])
  @@index([isGlobal])
  @@index([status])
}

model VehicleType {
  id        Int      @id @default(autoincrement())
  tenantId  String? // Nullable: NULL = global, populated = tenant-specific
  isGlobal  Boolean  @default(false) // Global Knowledge Base flag
  name      String
  status    Status   @default(ACTIVE) // Soft delete support
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant?   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vehicles Vehicle[]

  @@unique([tenantId, name])
  @@index([isGlobal])
  @@index([status])
}

model Vehicle {
  id             Int              @id @default(autoincrement())
  tenantId       String
  licensePlate   String
  brandId        Int
  lineId         Int
  typeId         Int
  year           Int
  color          String
  mileage        Int              @default(0)
  status         VehicleStatus    @default(ACTIVE)
  situation      VehicleSituation @default(AVAILABLE)
  photo          String?
  cylinder       Int?
  bodyWork       String?
  engineNumber   String?
  chasisNumber   String?
  ownerCard      String?
  owner          VehicleOwner     @default(OWN)
  typePlate      PlateType        @default(PARTICULAR)
  lastKilometers Int?
  lastRecorder   DateTime?        @default(now())

  // ===== CAMPOS ADICIONALES PARA CV (Hoja de Vida) =====
  fuelType    FuelType? // DIESEL, GASOLINA, GAS, ELECTRICO, HIBRIDO
  serviceType ServiceType? // PUBLICO, PARTICULAR, OFICIAL

  // Contacto de emergencia
  emergencyContactName  String?
  emergencyContactPhone String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant                    Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  brand                     VehicleBrand               @relation(fields: [brandId], references: [id])
  line                      VehicleLine                @relation(fields: [lineId], references: [id])
  type                      VehicleType                @relation(fields: [typeId], references: [id])
  documents                 Document[]
  workOrders                WorkOrder[]
  odometerLogs              OdometerLog[]
  maintenanceAlerts         MaintenanceAlert[]
  vehicleDrivers            VehicleDriver[]
  vehicleMantProgram        VehicleMantProgram? // ✅ CURRENT ARCHITECTURE

  @@unique([tenantId, licensePlate])
  @@index([tenantId])
  @@index([licensePlate])
  @@index([brandId])
  @@index([lineId])
  @@index([typeId])
}

// ========================================
// MAINTENANCE SYSTEM
// ========================================

model MantCategory {
  id          Int      @id @default(autoincrement())
  tenantId    String? // Nullable: NULL = global, populated = tenant-specific
  isGlobal    Boolean  @default(false) // Global Knowledge Base flag
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant           Tenant?           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  mantItems        MantItem[]
  mantItemRequests MantItemRequest[]

  @@unique([tenantId, name])
  @@index([isGlobal])
}

model MantItem {
  id          Int      @id @default(autoincrement())
  tenantId    String? // Nullable: NULL = global, populated = tenant-specific
  isGlobal    Boolean  @default(false) // Global Knowledge Base flag
  name        String
  description String?
  mantType    MantType
  categoryId  Int
  status      Status   @default(ACTIVE)

  // NUEVO: Discriminación de tipo y vinculación con MasterPart
  type ItemType @default(ACTION) // ACTION, PART, SERVICE

  // ❌ REMOVIDOS (migrados a PackageItem y VehicleProgramItem):
  // - estimatedTime: Ahora en PackageItem (específico por tipo de máquina)
  // - estimatedCost: Ahora en VehicleProgramItem (volátil por país/moneda)
  // - technicalNotes: Ahora en PackageItem (notas del procedimiento universal)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant              Tenant?              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category            MantCategory         @relation(fields: [categoryId], references: [id])
  packageItems        PackageItem[] // ✅ CURRENT (Template items)
  workOrderItems      WorkOrderItem[]
  vehicleProgramItems VehicleProgramItem[] // ✅ CURRENT ARCHITECTURE
  parts               MantItemPart[] // Legacy: vínculo genérico sin contexto vehículo
  vehicleParts        MantItemVehiclePart[] // KB: repuestos por marca/línea/año
  purchaseOrderItems  PurchaseOrderItem[]

  @@unique([tenantId, name])
  @@index([categoryId])
  @@index([type])
  @@index([isGlobal])
}

// Solicitudes de nuevos MantItems (TECHNICIAN/PURCHASER → OWNER/MANAGER aprueba)
model MantItemRequest {
  id        Int    @id @default(autoincrement())
  tenantId  String

  // Datos del item solicitado
  suggestedName String
  description   String?
  mantType      MantType
  categoryId    Int
  type          ItemType @default(ACTION)
  justification String?  @db.Text // Por qué se necesita

  // Items similares encontrados (snapshot del fuzzy search)
  similarItems Json? // [{ id, name, score }] - para auditoría

  // Workflow
  status     MantItemRequestStatus @default(PENDING)
  requestedBy String // User ID
  resolvedBy  String? // User ID OWNER/MANAGER
  resolvedAt  DateTime?
  rejectionReason String? @db.Text

  // Referencia al item creado si fue aprobado
  createdMantItemId Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category MantCategory @relation(fields: [categoryId], references: [id])

  @@index([tenantId])
  @@index([status])
  @@index([requestedBy])
}

// ========================================
// KNOWLEDGE BASE: Repuestos por Vehículo
// Vincula MantItem + Marca + Línea + Año → MasterPart específico
// ========================================

model MantItemVehiclePart {
  id               Int      @id @default(autoincrement())
  tenantId         String?
  isGlobal         Boolean  @default(false)

  // Item de mantenimiento (ej: "Cambio de filtro de aire")
  mantItemId       Int
  mantItem         MantItem @relation(fields: [mantItemId], references: [id])

  // Contexto vehículo (todo por FK, cero strings libres)
  vehicleBrandId   Int
  vehicleBrand     VehicleBrand @relation(fields: [vehicleBrandId], references: [id])
  vehicleLineId    Int
  vehicleLine      VehicleLine @relation(fields: [vehicleLineId], references: [id])
  yearFrom         Int? // Año desde (ej: 2020)
  yearTo           Int? // Año hasta (ej: 2024, null = vigente)

  // Repuesto específico (FK a MasterPart)
  masterPartId     String
  masterPart       MasterPart @relation("VehiclePartSpec", fields: [masterPartId], references: [id])

  // Equivalentes informativos (texto libre, NO formalizados)
  alternativePartNumbers String? @db.Text // "BOSCH F026400391, MANN C2443"
  notes            String?

  // Cantidad necesaria (ej: 4.5 litros de aceite)
  quantity         Decimal  @default(1) @db.Decimal(10, 2)

  tenant           Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([mantItemId, vehicleBrandId, vehicleLineId, yearFrom, masterPartId])
  @@index([mantItemId])
  @@index([vehicleBrandId, vehicleLineId])
  @@index([masterPartId])
  @@index([isGlobal])
}

// ========================================
// MAINTENANCE TEMPLATES & PACKAGES SYSTEM
// ========================================

model MaintenanceTemplate {
  id             Int      @id @default(autoincrement())
  tenantId       String? // Nullable: NULL = global, populated = tenant-specific
  isGlobal       Boolean  @default(false) // Global Knowledge Base flag
  name           String // "Toyota Hilux Standard", "Ford Ranger Heavy Duty"
  description    String?
  vehicleBrandId Int // Requerido: específico para una marca
  vehicleLineId  Int // Requerido: específico para una línea
  version        String   @default("1.0") // Para tracking de versiones
  isDefault      Boolean  @default(false) // Template por defecto para esta marca/línea
  status         Status   @default(ACTIVE)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant   Tenant?              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  brand    VehicleBrand         @relation(fields: [vehicleBrandId], references: [id])
  line     VehicleLine          @relation(fields: [vehicleLineId], references: [id])
  packages MaintenancePackage[]

  @@unique([tenantId, name])
  @@index([vehicleBrandId])
  @@index([vehicleLineId])
  @@index([isDefault])
  @@index([isGlobal])
}

model MaintenancePackage {
  id            Int      @id @default(autoincrement())
  templateId    Int
  name          String // "Mantenimiento 5,000 km", "Mantenimiento 15,000 km"
  triggerKm     Int? // Nullable para Mantenimiento Correctivo
  description   String?
  estimatedCost Decimal? @db.Decimal(10, 2) // Costo estimado total del paquete
  estimatedTime Decimal? @db.Decimal(5, 2) // Tiempo estimado total en horas
  priority      Priority @default(MEDIUM)
  packageType   MantType @default(PREVENTIVE)
  isPattern     Boolean  @default(true) // True = Preventivo (Patrón), False = Correctivo (Receta)
  status        Status   @default(ACTIVE)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  template     MaintenanceTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  packageItems PackageItem[]

  @@unique([templateId, name]) // Un template no puede tener 2 paquetes con el mismo nombre
  @@index([templateId])
  @@index([triggerKm])
}

model PackageItem {
  id         Int      @id @default(autoincrement())
  packageId  Int
  mantItemId Int
  triggerKm  Int // Km en que se ejecuta este item específico
  priority   Priority @default(MEDIUM) // Prioridad específica del item en este paquete

  // ✅ DATOS UNIVERSALES (funcionan en cualquier país)
  estimatedTime  Decimal? @db.Decimal(5, 2) // Tiempo universal por tipo de máquina
  technicalNotes String?  @db.Text // Notas del procedimiento (universales)

  isOptional Boolean  @default(false) // Si el item es opcional en el paquete
  order      Int      @default(0) // Orden de ejecución dentro del paquete
  status     Status   @default(ACTIVE) // Estado del item en este paquete
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // ❌ REMOVIDO: estimatedCost (volátil por país/moneda - ahora en VehicleProgramItem)

  package  MaintenancePackage @relation(fields: [packageId], references: [id], onDelete: Cascade)
  mantItem MantItem           @relation(fields: [mantItemId], references: [id])

  @@unique([packageId, mantItemId]) // Un paquete no puede tener el mismo item duplicado
  @@index([packageId])
  @@index([mantItemId])
  @@index([triggerKm])
  @@index([priority])
  @@index([status])
}


// ========================================
// WORK ORDERS (EXTENDIDO)
// ========================================

model WorkOrder {
  id              Int             @id @default(autoincrement())
  tenantId        String
  vehicleId       Int
  title           String
  description     String?
  mantType        MantType
  priority        Priority
  status          WorkOrderStatus @default(PENDING)
  workType        WorkType        @default(EXTERNAL) // EXTERNAL | INTERNAL | MIXED
  technicianId    Int?
  providerId      Int?
  creationMileage Int

  // CONEXIÓN CON PAQUETES DE MANTENIMIENTO
  isPackageWork Boolean @default(false) // true si es WorkOrder de paquete completo
  packageName   String? // Nombre del paquete si aplica

  // Campos de trazabilidad financiera
  requestedBy   String // User ID solicitante
  authorizedBy  String? // User ID autorizador
  estimatedCost Decimal? @db.Decimal(10, 2) // Costo estimado
  actualCost    Decimal? @db.Decimal(10, 2) // Costo real final
  costCenter    String? // Centro de costos
  budgetCode    String? // Código presupuestario

  // Campos legacy (mantener compatibilidad)
  plannedAmount Decimal? @db.Decimal(10, 2)
  realAmount    Decimal? @db.Decimal(10, 2)

  startDate DateTime?
  endDate   DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  tenant                 Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vehicle                Vehicle                 @relation(fields: [vehicleId], references: [id])
  technician             Technician?             @relation(fields: [technicianId], references: [id])
  provider               Provider?               @relation(fields: [providerId], references: [id])
  workOrderItems         WorkOrderItem[]
  workOrderExpenses      WorkOrderExpense[]
  approvals              WorkOrderApproval[]
  auditLogs              ExpenseAuditLog[]
  vehicleProgramPackages VehicleProgramPackage[] // ✅ CURRENT ARCHITECTURE
  maintenanceAlerts      MaintenanceAlert[] // ✅ Relación 1-to-many con alertas
  financialAlerts        FinancialAlert[] // ✅ Nueva relación
  invoices               Invoice[] // ✅ Facturas vinculadas a esta WO
  internalWorkTickets    InternalWorkTicket[]
  purchaseOrders         PurchaseOrder[]

  @@index([tenantId])
  @@index([vehicleId])
  @@index([status])
  @@index([requestedBy])
  @@index([authorizedBy])
  @@index([isPackageWork]) // Para separar WorkOrders de paquetes vs individuales
}

model WorkOrderItem {
  id          Int @id @default(autoincrement())
  workOrderId Int
  mantItemId  Int

  // Detalles del item/repuesto
  description String
  partNumber  String?
  brand       String?
  supplier    String

  // Costos detallados
  unitPrice Decimal @db.Decimal(10, 2)
  quantity  Int     @default(1)
  totalCost Decimal @db.Decimal(10, 2)

  // Trazabilidad
  purchasedBy   String // User ID quien compró
  invoiceNumber String?
  receiptUrl    String? // URL del recibo escaneado

  // Vinculación con MasterPart (repuesto específico)
  masterPartId String?
  masterPart   MasterPart? @relation(fields: [masterPartId], references: [id])

  // Campos de Cierre Mixto (Internal vs External)
  closureType           ItemClosureType @default(PENDING)
  invoiceItemId         String?
  internalTicketEntryId String?
  closedAt              DateTime?
  closedBy              String?

  // Fuente del item
  itemSource ItemSource @default(EXTERNAL) // EXTERNAL | INTERNAL_STOCK | INTERNAL_PURCHASE

  // Campos legacy
  cost             Decimal?        @db.Decimal(10, 2)
  executionMileage Int?
  notes            String?
  status           WorkOrderStatus @default(PENDING)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  workOrder          WorkOrder          @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  mantItem           MantItem           @relation(fields: [mantItemId], references: [id])
  invoiceItems       InvoiceItem[] // ✅ Items de factura vinculados
  ticketLaborEntries TicketLaborEntry[]
  ticketPartEntries  TicketPartEntry[]
  purchaseOrderItems PurchaseOrderItem[]

  @@index([workOrderId])
  @@index([mantItemId])
  @@index([supplier])
  @@index([purchasedBy])
}

model WorkOrderExpense {
  id            String      @id @default(cuid())
  workOrderId   Int
  expenseType   ExpenseType
  description   String
  amount        Decimal     @db.Decimal(10, 2)
  
  // Proveedor (Opcional: puede ser externo sin registrar o registrado)
  vendor        String?     // Nombre texto libre (fallback)
  providerId    Int?
  provider      Provider?   @relation(fields: [providerId], references: [id])
  
  invoiceNumber String?
  receiptUrl    String? // URL del recibo escaneado
  expenseDate   DateTime    @default(now())
  recordedBy    String // User ID quien registró
  
  status        ApprovalStatus @default(PENDING) // ✅ Nuevo campo para aprobación
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@index([expenseType])
  @@index([vendor])
  @@index([providerId])
  @@index([recordedBy])
  @@index([status])
}

model WorkOrderApproval {
  id            String         @id @default(cuid())
  workOrderId   Int
  approverLevel Int // 1=supervisor, 2=manager, 3=admin
  approvedBy    String // User ID
  approvedAt    DateTime       @default(now())
  amount        Decimal        @db.Decimal(10, 2)
  notes         String?
  status        ApprovalStatus @default(PENDING)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@index([approverLevel])
  @@index([approvedBy])
  @@index([status])
}

model ExpenseAuditLog {
  id            String      @id @default(cuid())
  workOrderId   Int
  action        AuditAction // CREATED, APPROVED, MODIFIED, PAID
  previousValue Json?
  newValue      Json
  performedBy   String // User ID
  performedAt   DateTime    @default(now())
  ipAddress     String?
  userAgent     String? // Para mejor trazabilidad
  createdAt     DateTime    @default(now())

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@index([performedBy])
  @@index([performedAt])
}

// ========================================
// INVOICE & MASTER PARTS SYSTEM (FASE 1-3)
// Sistema de facturación y catálogo de artículos
// ========================================

// 1. Master de Artículos - Catálogo compartido entre tenants
model MasterPart {
  id       String  @id @default(cuid())
  tenantId String? // NULL = compartido globalmente, FK = específico del tenant

  // Identificación
  code        String  @unique // "BOSCH-123", "SHELL-5W40-SYNT"
  description String // "Filtro aceite motor BOSCH"
  category    String // "FILTROS", "ACEITES", "LUBRICANTES"
  subcategory String? // "FILTROS_ACEITE", "FILTROS_AIRE"
  unit        String  @default("UNIDAD") // "UNIDAD", "LITRO", "GALÓN", "KG"

  // Precio referencia (último conocido)
  referencePrice  Decimal?  @db.Decimal(10, 2)
  lastPriceUpdate DateTime?

  // Specs técnicas (JSON flexible para FASE 3)
  specifications Json? // { "viscosity": "5W-40", "type": "synthetic", "apiRating": "SN/CF" }

  // Alternativas/Equivalentes (FASE 2-3)
  alternativeFor  String? // FK a otro MasterPart (ej: genérico equivalente)
  alternativePart MasterPart?  @relation("Alternatives", fields: [alternativeFor], references: [id], onDelete: SetNull)
  alternatives    MasterPart[] @relation("Alternatives")

  // Metadata
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  mantItemParts        MantItemPart[]
  mantItemVehicleParts MantItemVehiclePart[] @relation("VehiclePartSpec") // KB: repuestos por vehículo
  invoiceItems         InvoiceItem[]
  priceHistory         PartPriceHistory[]
  compatibilities      PartCompatibility[] // FASE 3
  inventoryItems       InventoryItem[]
  financialAlerts      FinancialAlert[] // ✅ Relación inversa
  workOrderItems       WorkOrderItem[]
  purchaseOrderItems   PurchaseOrderItem[]

  @@index([category])
  @@index([tenantId])
  @@index([code])
  @@index([isActive])
}

// 2. Tabla intermedia: MantItem ↔ MasterPart (many-to-many)
model MantItemPart {
  id           String     @id @default(cuid())
  mantItemId   Int
  mantItem     MantItem   @relation(fields: [mantItemId], references: [id], onDelete: Cascade)
  masterPartId String
  masterPart   MasterPart @relation(fields: [masterPartId], references: [id], onDelete: Restrict)

  quantity   Decimal @default(1) @db.Decimal(10, 2) // Ej: 4.5 litros de aceite
  isRequired Boolean @default(true) // Requerido vs opcional
  isPrimary  Boolean @default(false) // Artículo principal del item

  // Notas específicas de este vínculo
  notes String? // "Alternativamente usar CASTROL 5W-40"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([mantItemId, masterPartId])
  @@index([mantItemId])
  @@index([masterPartId])
}

// 3. Invoice - Factura del proveedor
model Invoice {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Identificación factura
  invoiceNumber String // Número de factura del proveedor
  invoiceDate   DateTime // Fecha emisión factura
  dueDate       DateTime? // Fecha vencimiento pago

  // Proveedor (reutilizamos Provider existente, lo renombraremos a Supplier)
  supplierId Int
  supplier   Provider @relation(fields: [supplierId], references: [id], onDelete: Restrict)

  // Vinculación con trabajo (opcional si factura es de WO)
  workOrderId Int?
  workOrder   WorkOrder? @relation(fields: [workOrderId], references: [id], onDelete: SetNull)

  // Vinculación con orden de compra (opcional)
  purchaseOrderId String?
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id], onDelete: SetNull)

  // Montos
  subtotal    Decimal @db.Decimal(10, 2)
  taxAmount   Decimal @default(0) @db.Decimal(10, 2)
  totalAmount Decimal @db.Decimal(10, 2)
  currency    String  @default("COP")

  // Estado
  status InvoiceStatus @default(PENDING)

  // Aprobación y auditoría
  approvedBy String?
  approver   User?     @relation("InvoiceApprover", fields: [approvedBy], references: [id], onDelete: SetNull)
  approvedAt DateTime?

  registeredBy String // Usuario que registró la factura
  registrar    User   @relation("InvoiceRegistrar", fields: [registeredBy], references: [id], onDelete: Restrict)

  // Notas y adjuntos
  notes         String? @db.Text
  attachmentUrl String? // URL a factura escaneada/PDF

  // ============ CAMPOS OCR ============
  pdfUrl         String? // URL en Supabase Storage
  ocrStatus      OCRStatus @default(PENDING)
  ocrRawData     Json? // JSON completo de Vision API
  ocrConfidence  Decimal?  @db.Decimal(5, 2) // Promedio confianza 0-100
  ocrProcessedAt DateTime?
  needsReview    Boolean   @default(false) // true si confianza < 70%

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  items        InvoiceItem[]
  payments     InvoicePayment[] // FASE 2
  priceHistory PartPriceHistory[]
  financialAlerts FinancialAlert[] // ✅ Relación inversa

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
  @@index([supplierId])
  @@index([workOrderId])
  @@index([purchaseOrderId])
  @@index([invoiceDate])
}

// 4. InvoiceItem - Línea de factura (granular)
model InvoiceItem {
  id        String  @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Vinculación con catálogo (CLAVE para analytics)
  masterPartId String? // Nullable: permite registrar sin catálogo inicialmente
  masterPart   MasterPart? @relation(fields: [masterPartId], references: [id], onDelete: SetNull)

  // Vinculación con trabajo realizado (traza: alerta → WO → factura)
  workOrderItemId Int?
  workOrderItem   WorkOrderItem? @relation(fields: [workOrderItemId], references: [id], onDelete: SetNull)

  // Datos de factura (lo que dice el documento físico)
  description String // Texto exacto de la factura
  quantity    Decimal @db.Decimal(10, 2)
  unitPrice   Decimal @db.Decimal(10, 2) // Precio real pagado
  subtotal    Decimal @db.Decimal(10, 2)
  taxRate     Decimal @default(0) @db.Decimal(5, 2)
  taxAmount   Decimal @default(0) @db.Decimal(10, 2)
  total       Decimal @db.Decimal(10, 2)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
  @@index([masterPartId])
  @@index([workOrderItemId])
}

// 5. Histórico de precios por artículo + proveedor (GOLD MINE para analytics)
model PartPriceHistory {
  id       String @id @default(cuid())
  tenantId String // Precios son específicos del tenant

  // Artículo
  masterPartId String
  masterPart   MasterPart @relation(fields: [masterPartId], references: [id], onDelete: Cascade)

  // Proveedor
  supplierId Int
  supplier   Provider @relation(fields: [supplierId], references: [id], onDelete: Restrict)

  // Precio y contexto
  price      Decimal  @db.Decimal(10, 2)
  quantity   Decimal  @default(1) @db.Decimal(10, 2) // Por si aplican descuentos por volumen
  recordedAt DateTime @default(now())

  // Auditoría (RESPONDE: "¿Quién autorizó esta compra?")
  invoiceId   String?
  invoice     Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  approvedBy  String?
  approver    User?    @relation("PriceHistoryApprover", fields: [approvedBy], references: [id], onDelete: SetNull)
  purchasedBy String? // Usuario que gestionó la compra
  purchaser   User?    @relation("PriceHistoryPurchaser", fields: [purchasedBy], references: [id], onDelete: SetNull)

  // Metadata
  createdAt DateTime @default(now())

  @@index([masterPartId, supplierId])
  @@index([tenantId])
  @@index([recordedAt])
  @@index([approvedBy])
}

// ========================================
// FASE 2-3: MODELOS FUTUROS
// ========================================

// 6. Pagos de facturas (FASE 2 - control financiero)
model InvoicePayment {
  id        String  @id @default(cuid())
  tenantId  String // Multi-tenant support
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  amount          Decimal  @db.Decimal(10, 2)
  paymentDate     DateTime
  paymentMethod   String // "TRANSFERENCIA", "CHEQUE", "EFECTIVO"
  referenceNumber String? // Número de transferencia/cheque

  registeredBy String
  registrar    User   @relation("PaymentRegistrar", fields: [registeredBy], references: [id], onDelete: Restrict)

  notes     String?
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([invoiceId])
  @@index([paymentDate])
}

// ========================================
// PURCHASE ORDER SYSTEM
// ========================================

model PurchaseOrder {
  id        String @id @default(cuid())
  tenantId  String
  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relacion con OT
  workOrderId Int
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Restrict)

  // Numero y tipo
  orderNumber String            // "OC-2026-000001"
  type        PurchaseOrderType // SERVICES | PARTS

  // Proveedor
  providerId Int
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Restrict)

  // Estado con flujo de aprobacion
  status PurchaseOrderStatus @default(DRAFT)

  // Aprobacion
  requestedBy String // userId que creo
  approvedBy  String? // userId que aprobo
  approvedAt  DateTime?
  sentAt      DateTime?

  // Montos
  subtotal  Decimal @db.Decimal(12, 2)
  taxRate   Decimal @db.Decimal(5, 2) @default(0)
  taxAmount Decimal @db.Decimal(12, 2) @default(0)
  total     Decimal @db.Decimal(12, 2)

  // Items y facturas
  items    PurchaseOrderItem[]
  invoices Invoice[] // Facturas que cancelan esta OC

  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([workOrderId])
  @@index([providerId])
  @@index([status])
}

model PurchaseOrderItem {
  id              String        @id @default(cuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  // Vinculo con WorkOrderItem (trazabilidad)
  workOrderItemId Int?
  workOrderItem   WorkOrderItem? @relation(fields: [workOrderItemId], references: [id], onDelete: SetNull)

  // Item de mantenimiento
  mantItemId Int?
  mantItem   MantItem? @relation(fields: [mantItemId], references: [id], onDelete: SetNull)

  // Repuesto (si aplica)
  masterPartId String?
  masterPart   MasterPart? @relation(fields: [masterPartId], references: [id], onDelete: SetNull)

  // Datos del item
  description String
  quantity    Decimal @db.Decimal(10, 2)
  unitPrice   Decimal @db.Decimal(12, 2)
  total       Decimal @db.Decimal(12, 2)

  // Estado de recepcion/facturacion
  status      POItemStatus @default(PENDING)
  receivedQty Decimal      @db.Decimal(10, 2) @default(0)

  // Referencia a factura que cancela este item
  invoiceItemId String?
  closedAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([purchaseOrderId])
  @@index([workOrderItemId])
  @@index([mantItemId])
  @@index([masterPartId])
  @@index([status])
}

// 7. Compatibilidad de artículos por vehículo (FASE 3 - para sugerir alternativas)
model PartCompatibility {
  id           String     @id @default(cuid())
  tenantId     String? // Nullable: NULL = global, populated = tenant-specific
  masterPartId String
  masterPart   MasterPart @relation(fields: [masterPartId], references: [id], onDelete: Cascade)

  // Filtros de compatibilidad (NULL = aplica a todos)
  brand        String? // "Toyota"
  model        String? // "Hilux"
  yearFrom     Int? // 2020
  yearTo       Int? // 2024
  engineType   String? // "Diesel 2.8L", "Gasolina 2.7L"
  transmission String? // "Manual", "Automática"

  // Nivel de compatibilidad
  compatibility CompatibilityLevel @default(COMPATIBLE)

  notes      String?   @db.Text
  verifiedBy String? // Usuario que verificó compatibilidad
  verifiedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([masterPartId])
  @@index([brand, model])
}

// ========================================
// PEOPLE & PROVIDERS
// ========================================

model Technician {
  id        Int                  @id @default(autoincrement())
  tenantId  String
  name      String
  email     String?
  phone     String?
  specialty TechnicianSpecialty?
  status    Status               @default(ACTIVE)
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  tenant                 Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workOrders             WorkOrder[]
  vehicleProgramPackages VehicleProgramPackage[] // ✅ CURRENT ARCHITECTURE
  vehicleProgramItems    VehicleProgramItem[] // ✅ CURRENT ARCHITECTURE
  internalWorkTickets    InternalWorkTicket[]
  ticketLaborEntries     TicketLaborEntry[]

  // Datos para Taller Interno
  employmentType EmploymentType @default(INTERNAL)
  hourlyRate     Decimal?       @db.Decimal(10, 2)
  location       String?

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Provider {
  id        Int                @id @default(autoincrement())
  tenantId  String
  name      String
  email     String?
  phone     String?
  address   String?
  specialty ProviderSpecialty?
  status    Status             @default(ACTIVE)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  tenant                 Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workOrders             WorkOrder[]
  vehicleProgramPackages VehicleProgramPackage[] // ✅ CURRENT ARCHITECTURE
  vehicleProgramItems    VehicleProgramItem[] // ✅ CURRENT ARCHITECTURE
  invoices               Invoice[] // ✅ Facturas del proveedor
  priceHistory           PartPriceHistory[] // ✅ Histórico de precios
  workOrderExpenses      WorkOrderExpense[] // ✅ Gastos asignados
  purchaseOrders         PurchaseOrder[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Driver {
  id            Int       @id @default(autoincrement())
  tenantId      String
  name          String
  email         String?
  phone         String?
  licenseNumber String?
  licenseExpiry DateTime?
  status        Status    @default(ACTIVE)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  odometerLogs   OdometerLog[]
  vehicleDrivers VehicleDriver[]

  @@unique([tenantId, licenseNumber])
  @@index([tenantId])
}

model VehicleDriver {
  id         Int       @id @default(autoincrement())
  tenantId   String // Multi-tenant support
  vehicleId  Int
  driverId   Int
  status     Status    @default(ACTIVE) // ACTIVE/INACTIVE
  isPrimary  Boolean   @default(false) // Conductor principal del vehículo
  startDate  DateTime  @default(now()) // Fecha inicio de asignación
  endDate    DateTime? // Fecha fin de asignación (opcional)
  notes      String? // Notas sobre la asignación
  assignedBy String? // ID del usuario que asignó
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  driver  Driver  @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@unique([tenantId, vehicleId, driverId]) // No duplicados por tenant
  @@index([tenantId])
  @@index([vehicleId])
  @@index([driverId])
  @@index([status])
  @@index([startDate])
}

// ========================================
// MONITORING & ALERTS
// ========================================

model OdometerLog {
  id          Int                 @id @default(autoincrement())
  vehicleId   Int
  driverId    Int?
  kilometers  Int?
  hours       Int?
  measureType OdometerMeasureType @default(KILOMETERS)
  recordedAt  DateTime            @default(now())
  createdAt   DateTime            @default(now())

  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  driver  Driver? @relation(fields: [driverId], references: [id])

  @@index([vehicleId])
  @@index([driverId])
  @@index([recordedAt])
}

model MaintenanceAlert {
  id            Int    @id @default(autoincrement())
  tenantId      String
  vehicleId     Int
  programItemId Int // VehicleProgramItem específico (granular)

  // TIPO Y CLASIFICACIÓN
  type     AlertType     @default(PREVENTIVE)
  category AlertCategory // CRITICAL_SAFETY, MAJOR_COMPONENT, ROUTINE, MINOR

  // CONTEXTO (copiado del item al crear alerta)
  itemName          String // "Cambio aceite motor"
  packageName       String // "Mantenimiento 15,000 km" (contexto visual)
  description       String?
  estimatedCost     Decimal? @db.Decimal(10, 2)
  estimatedDuration Decimal? @db.Decimal(5, 2) // Horas

  // NUEVO: Info técnica heredada de MantItem
  technicalNotes   String? @db.Text // Copiado de MantItem.technicalNotes
  recommendedParts Json? // Snapshot de parts recomendados
  customNotes      String? @db.Text // Admin puede agregar notas específicas

  // KILOMETRAJE
  scheduledKm         Int // Km programado del item
  currentKmAtCreation Int // Km cuando se generó alerta
  currentKm           Int // Km actual (actualizado por cron)
  kmToMaintenance     Int // scheduledKm - currentKm
  alertThresholdKm    Int // Umbral que disparó (1000, 500, etc)

  // PRIORIZACIÓN INTELIGENTE
  priority      Priority   @default(MEDIUM)
  alertLevel    AlertLevel // LOW, MEDIUM, HIGH, CRITICAL (semaforización)
  priorityScore Int        @default(50) // 0-100 calculado

  // ESTADO Y WORKFLOW
  status AlertStatus @default(PENDING)

  // TRACKING DE ATENCIÓN
  viewedBy       String[] // Array de user IDs que vieron
  firstViewedAt  DateTime?
  acknowledgedBy String?
  acknowledgedAt DateTime?

  // SNOOZE (posponer)
  snoozedUntil DateTime?
  snoozeReason String?
  snoozedBy    String?

  // CONEXIÓN CON WORKORDER
  workOrderId        Int?
  workOrderCreatedAt DateTime?
  workOrderCreatedBy String?

  // MÉTRICAS DE PERFORMANCE
  responseTimeMinutes Int? // Minutos desde creación hasta WO
  completionTimeHours Int? // Horas desde WO hasta cierre
  wasOnTime           Boolean? // ¿Se completó antes de vencer?
  actualCost          Decimal? @db.Decimal(10, 2)
  costVariance        Decimal? @db.Decimal(10, 2) // actualCost - estimatedCost

  // NOTIFICACIONES
  notificationsSent  Int       @default(0)
  lastNotificationAt DateTime?

  // AUDITORÍA
  notes        String?
  cancelReason String?
  cancelledBy  String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  closedAt     DateTime?

  // RELACIONES
  tenant      Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vehicle     Vehicle            @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  programItem VehicleProgramItem @relation(fields: [programItemId], references: [id], onDelete: Cascade)
  workOrder   WorkOrder?         @relation(fields: [workOrderId], references: [id])

  @@unique([programItemId, status])
  @@index([tenantId])
  @@index([vehicleId])
  @@index([programItemId])
  @@index([status])
  @@index([type])
  @@index([priority])
  @@index([alertLevel])
  @@index([scheduledKm])
  @@index([wasOnTime])
}

// ========================================
// FINANCIAL CONTROL & WATCHDOG
// ========================================

model FinancialAlert {
  id            Int      @id @default(autoincrement())
  tenantId      String
  
  // Relaciones Opciónales
  invoiceId     String?
  invoice       Invoice? @relation(fields: [invoiceId], references: [id])
  workOrderId   Int?
  workOrder     WorkOrder? @relation(fields: [workOrderId], references: [id])
  masterPartId  String?
  masterPart    MasterPart? @relation(fields: [masterPartId], references: [id])
  
  type          AlertType // PRICE_DEVIATION, BUDGET_OVERRUN
  severity      AlertLevel // HIGH, CRITICAL, FINANCIAL
  status        AlertStatus @default(PENDING)
  
  message       String   // "Precio de Filtro Aceite (20.00) excede referencia (10.00) en 100%"
  details       Json?    // { expected: 10, actual: 20, deviation: 100 }
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Gestión
  acknowledgedBy String?
  acknowledgedAt DateTime?
  resolvedBy     String?
  resolvedAt     DateTime?
  resolution     String? // "Precio aceptado por urgencia"
  
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@index([type])
  @@index([severity])
}

model Document {
  id             String @id @default(uuid())
  tenantId       String
  vehicleId      Int
  documentTypeId Int

  // Metadata del ARCHIVO físico
  fileName String // Nombre del archivo subido (ej: "soat-toyota-abc123.pdf")
  fileUrl  String // URL del archivo en uploadthing

  // Información del DOCUMENTO legal
  documentNumber String? // Número oficial del documento (ej: "2508004334695000")
  entity         String? // Entidad emisora (ej: "SURA", "Seguros Equidad")

  expiryDate DateTime?
  status     DocumentStatus @default(ACTIVE)
  uploadedAt DateTime       @default(now())
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  tenant       Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vehicle      Vehicle            @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  documentType DocumentTypeConfig @relation(fields: [documentTypeId], references: [id])

  @@index([tenantId])
  @@index([vehicleId])
  @@index([documentTypeId])
  @@index([expiryDate])
  @@index([documentNumber])
}

model DocumentTypeConfig {
  id                 Int      @id @default(autoincrement())
  tenantId           String? // NULL = global, populated = tenant-specific
  isGlobal           Boolean  @default(false)
  countryCode        String // ISO alpha-2: CO, MX, ES, AR, US
  code               String // Código único: SOAT, TECNOMECANICA, ITV, etc.
  name               String // Nombre display: "SOAT", "Revisión Técnico-Mecánica"
  description        String?
  requiresExpiry     Boolean  @default(true) // ¿Documento debe tener fecha de vencimiento?
  isMandatory        Boolean  @default(false) // ¿Obligatorio para que el vehículo circule?
  expiryWarningDays  Int      @default(30) // Días para alerta WARNING
  expiryCriticalDays Int      @default(7) // Días para alerta CRITICAL
  sortOrder          Int      @default(0)
  status             Status   @default(ACTIVE)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  tenant    Tenant?    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  documents Document[]

  @@unique([tenantId, code])
  @@index([isGlobal])
  @@index([countryCode])
  @@index([status])
}

// ========================================
// NUEVA ARQUITECTURA: VEHICLE MAINTENANCE PROGRAMS
// Arquitectura simplificada para mantenimiento preventivo/correctivo
// ========================================

model VehicleMantProgram {
  id          Int     @id @default(autoincrement())
  tenantId    String
  vehicleId   Int
  name        String // "Programa Toyota Hilux ABC-123"
  description String? // Descripción del programa

  // INFORMACIÓN DE ORIGEN
  generatedFrom String? // "Template: Toyota Hilux Standard v1.2"
  generatedAt   DateTime @default(now())
  generatedBy   String // User ID quien generó el programa

  // KILOMETRAJE INICIAL
  assignmentKm        Int // Km del vehículo cuando se asignó
  nextMaintenanceKm   Int? // Próximo vencimiento calculado
  nextMaintenanceDesc String? // Descripción del próximo mantenimiento

  // CONFIGURACIÓN Y ESTADO
  isActive  Boolean  @default(true)
  notes     String?
  status    Status   @default(ACTIVE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RELACIONES
  tenant   Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vehicle  Vehicle                 @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  packages VehicleProgramPackage[]

  @@unique([vehicleId]) // Un vehículo solo puede tener un programa activo
  @@index([tenantId])
  @@index([vehicleId])
  @@index([isActive])
  @@index([nextMaintenanceKm])
}

model VehicleProgramPackage {
  id          Int     @id @default(autoincrement())
  tenantId    String
  programId   Int
  name        String // "Mantenimiento 15,000 km" | "Items Correctivos"
  description String?

  // CONFIGURACIÓN DEL PAQUETE
  triggerKm   Int? // 15000, 30000, etc. | NULL para correctivos
  packageType MantType @default(PREVENTIVE) // PREVENTIVE, CORRECTIVE, PREDICTIVE
  priority    Priority @default(MEDIUM)

  // COSTOS Y TIEMPO
  estimatedCost Decimal? @db.Decimal(10, 2)
  estimatedTime Decimal? @db.Decimal(5, 2) // Horas
  actualCost    Decimal? @db.Decimal(10, 2)
  actualTime    Decimal? @db.Decimal(5, 2)

  // ESTADO Y EJECUCIÓN
  status      WorkOrderStatus @default(PENDING)
  scheduledKm Int? // Km programado específico para este vehículo
  executedKm  Int? // Km real de ejecución
  startDate   DateTime?
  endDate     DateTime?

  // ASIGNACIONES
  technicianId Int?
  providerId   Int?
  workOrderId  Int? // WorkOrder asociada
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // RELACIONES
  tenant     Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  program    VehicleMantProgram   @relation(fields: [programId], references: [id], onDelete: Cascade)
  technician Technician?          @relation(fields: [technicianId], references: [id])
  provider   Provider?            @relation(fields: [providerId], references: [id])
  workOrder  WorkOrder?           @relation(fields: [workOrderId], references: [id])
  items      VehicleProgramItem[]

  @@index([tenantId])
  @@index([programId])
  @@index([triggerKm])
  @@index([status])
  @@index([scheduledKm])
  @@index([packageType])
}

model VehicleProgramItem {
  id         Int    @id @default(autoincrement())
  tenantId   String
  packageId  Int // NUNCA NULL - siempre tiene package padre
  mantItemId Int // Referencia al MantItem base

  // TIPO Y CONFIGURACIÓN
  mantType MantType // PREVENTIVE, CORRECTIVE, PREDICTIVE
  priority Priority @default(MEDIUM)
  order    Int      @default(0) // Orden dentro del package

  // KILOMETRAJE Y FECHAS
  scheduledKm   Int? // Km programado
  detectedKm    Int? // Km cuando se detectó (correctivos)
  executedKm    Int? // Km real de ejecución
  scheduledDate DateTime?
  detectedDate  DateTime? // Para correctivos
  executedDate  DateTime?

  // ✅ COSTOS ESPECÍFICOS DEL TENANT (en moneda local)
  estimatedCost Decimal? @db.Decimal(10, 2) // Calculado según precios locales
  estimatedTime Decimal? @db.Decimal(5, 2) // Heredado de PackageItem
  actualCost    Decimal? @db.Decimal(10, 2) // Real ejecutado (de Invoice)
  actualTime    Decimal? @db.Decimal(5, 2)

  // ✅ NOTAS LOCALES (disponibilidad, alternativas por país)
  localNotes String? @db.Text // "En Colombia usar Shell Helix o Mobil 1"

  // ASIGNACIONES Y ESTADO
  technicianId Int?
  providerId   Int?
  status       WorkOrderStatus @default(PENDING)
  urgency      Boolean         @default(false) // Para correctivos urgentes
  notes        String?
  description  String? // Descripción específica del problema
  isOptional   Boolean         @default(false) // Si el item es opcional
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // RELACIONES
  tenant            Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  package           VehicleProgramPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)
  mantItem          MantItem              @relation(fields: [mantItemId], references: [id])
  technician        Technician?           @relation(fields: [technicianId], references: [id])
  provider          Provider?             @relation(fields: [providerId], references: [id])
  maintenanceAlerts MaintenanceAlert[]

  @@unique([packageId, mantItemId]) // Un package no puede tener el mismo item duplicado
  @@index([tenantId])
  @@index([packageId])
  @@index([mantItemId])
  @@index([mantType])
  @@index([status])
  @@index([scheduledKm])
  @@index([urgency])
}

// ========================================
// ENUMS
// ========================================

enum UserRole {
  SUPER_ADMIN // Dueño del SaaS - acceso total + tablas maestras
  OWNER // Dueño empresa cliente - acceso total a su tenant
  MANAGER // Gerente/Supervisor - gestión + costos
  PURCHASER // Comprador - Gestión de facturas, gastos y proveedores
  TECHNICIAN // Mecánico/Técnico - operación sin costos
  DRIVER // Conductor - solo odómetro
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PENDING_PAYMENT
  PAST_DUE
  CANCELED
  INCOMPLETE
}

enum PaymentStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  REFUNDED
  IN_PROCESS
}

enum VehicleStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
  SOLD
}

enum VehicleSituation {
  AVAILABLE
  IN_USE
  MAINTENANCE
}

enum VehicleOwner {
  OWN
  LEASED
  RENTED
}

enum PlateType {
  PARTICULAR
  PUBLICO
}

enum FuelType {
  DIESEL
  GASOLINA
  GAS
  ELECTRICO
  HIBRIDO
}

enum ServiceType {
  PUBLICO
  PARTICULAR
  OFICIAL
}

enum Status {
  ACTIVE
  INACTIVE
}

enum MantType {
  PREVENTIVE
  PREDICTIVE
  CORRECTIVE
  EMERGENCY
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum WorkOrderStatus {
  PENDING // Creada, sin asignar
  PENDING_APPROVAL // Esperando aprobación Manager/Owner
  APPROVED // Aprobada, lista para ejecución
  IN_PROGRESS // Técnico trabajando
  PENDING_INVOICE // Trabajo terminado, esperando factura
  COMPLETED // Cerrada con factura registrada
  REJECTED // Rechazada por Manager/Owner
  CANCELLED // Cancelada manualmente
}

enum ExpenseType {
  PARTS
  LABOR
  TRANSPORT
  TOOLS
  MATERIALS
  SERVICE
  OTHER
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum AuditAction {
  CREATED
  APPROVED
  REJECTED
  MODIFIED
  PAID
  CANCELLED
  COMPLETED
  FLAGGED // Para alertas
  ACKNOWLEDGED // Para alertas
}

enum AlertLevel {
  LOW // > 1000 km
  MEDIUM // 500-1000 km
  HIGH // < 500 km
  CRITICAL // Vencido
  FINANCIAL // Alerta financiera (desviación)
}

enum DocumentStatus {
  ACTIVE
  EXPIRED
  EXPIRING_SOON
}

enum OdometerMeasureType {
  KILOMETERS
  HOURS
}

enum TechnicianSpecialty {
  MOTOR
  TRANSMISION
  FRENOS
  SUSPENSION
  ELECTRICO
  ELECTRONICO
  AIRE_ACONDICIONADO
  PINTURA
  CARROCERIA
  SOLDADURA
  GENERAL
}

enum ProviderSpecialty {
  REPUESTOS
  LUBRICANTES
  NEUMATICOS
  BATERIAS
  FILTROS
  FRENOS
  SUSPENSION
  ELECTRICO
  PINTURA
  CARROCERIA
  SOLDADURA
  SERVICIOS_GENERALES
  GRUA
  SEGUROS
}


enum AlertStatus {
  PENDING // Generada, esperando atención
  ACKNOWLEDGED // Vista y reconocida por admin
  IN_PROGRESS // WorkOrder creada y asignada
  COMPLETED // Mantenimiento ejecutado
  CLOSED // Ciclo cerrado (WO + factura + costo)
  SNOOZED // Pospuesta temporalmente
  CANCELLED // Cancelada (vehículo vendido, plan cambiado)
}

enum AlertType {
  PREVENTIVE // Mantenimiento preventivo programado
  OVERDUE // Mantenimiento vencido (pasó el km)
  EARLY_WARNING // Aviso temprano (>1000km)
  PRICE_DEVIATION // Finanzas: Precio supera referencia
  BUDGET_OVERRUN // Finanzas: Costo supera estimado
}

enum AlertCategory {
  CRITICAL_SAFETY // Frenos, dirección, neumáticos
  MAJOR_COMPONENT // Motor, transmisión, suspensión
  ROUTINE // Aceite, filtros, lubricación
  MINOR // Limpieza, inspecciones visuales
}

// ========================================
// ENUMS - INVOICE & MASTER PARTS
// ========================================

enum ItemType {
  ACTION // Inspección, revisión (no factura artículo)
  PART // Repuesto facturable (filtro, aceite, etc.)
  SERVICE // Servicio completo (mano obra + materiales del proveedor)
}

enum InvoiceStatus {
  PENDING // Registrada, pendiente aprobación
  APPROVED // Aprobada para pago
  PAID // Pagada
  OVERDUE // Vencida
  CANCELLED // Cancelada
}

enum OCRStatus {
  PENDING // PDF subido, esperando procesamiento
  PROCESSING // Vision API procesando
  COMPLETED // OCR completado exitosamente
  FAILED // Error en procesamiento OCR
}

enum CompatibilityLevel {
  RECOMMENDED // OEM o recomendado fabricante
  COMPATIBLE // Compatible genérico
  CONDITIONAL // Compatible bajo condiciones
  INCOMPATIBLE // No compatible
}

// ========================================
// INVENTORY SYSTEM
// ========================================

model InventoryItem {
  id           String          @id @default(cuid())
  tenantId     String
  masterPartId String
  warehouse    String          @default("PRINCIPAL")
  location     String?
  quantity     Decimal         @db.Decimal(10, 2)
  minStock     Decimal         @default(0) @db.Decimal(10, 2)
  maxStock     Decimal?        @db.Decimal(10, 2)
  averageCost  Decimal         @db.Decimal(10, 2)
  totalValue   Decimal         @db.Decimal(10, 2)
  status       InventoryStatus @default(ACTIVE)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  tenant            Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  masterPart        MasterPart          @relation(fields: [masterPartId], references: [id])
  movements         InventoryMovement[]
  ticketPartEntries TicketPartEntry[]

  @@unique([tenantId, masterPartId, warehouse])
  @@index([tenantId])
  @@index([masterPartId])
  @@index([status])
}

model InventoryMovement {
  id              String                @id @default(cuid())
  tenantId        String
  inventoryItemId String
  movementType    MovementType
  quantity        Decimal               @db.Decimal(10, 2)
  unitCost        Decimal               @db.Decimal(10, 2)
  totalCost       Decimal               @db.Decimal(10, 2)
  previousStock   Decimal               @db.Decimal(10, 2)
  newStock        Decimal               @db.Decimal(10, 2)
  previousAvgCost Decimal               @db.Decimal(10, 2)
  newAvgCost      Decimal               @db.Decimal(10, 2)
  referenceType   MovementReferenceType
  referenceId     String
  performedBy     String
  performedAt     DateTime              @default(now())

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([inventoryItemId])
  @@index([movementType])
  @@index([performedAt])
}

// ========================================
// INTERNAL WORKSHOP SYSTEM
// ========================================

model InternalWorkTicket {
  id           String   @id @default(cuid())
  tenantId     String
  workOrderId  Int
  ticketNumber String // "TKT-2026-0001"
  ticketDate   DateTime @default(now())
  technicianId Int

  totalLaborHours Decimal @db.Decimal(5, 2)
  totalLaborCost  Decimal @db.Decimal(10, 2)
  totalPartsCost  Decimal @db.Decimal(10, 2)
  totalCost       Decimal @db.Decimal(10, 2)

  status      InternalTicketStatus @default(DRAFT)
  approvedBy  String?
  approvedAt  DateTime?
  description String?
  notes       String?              @db.Text
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  tenant       Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workOrder    WorkOrder          @relation(fields: [workOrderId], references: [id], onDelete: Restrict)
  technician   Technician         @relation(fields: [technicianId], references: [id])
  laborEntries TicketLaborEntry[]
  partEntries  TicketPartEntry[]

  @@unique([tenantId, ticketNumber])
  @@index([tenantId])
  @@index([workOrderId])
  @@index([technicianId])
  @@index([status])
}

model TicketLaborEntry {
  id              String   @id @default(cuid())
  ticketId        String
  workOrderItemId Int?
  description     String
  hours           Decimal  @db.Decimal(5, 2)
  hourlyRate      Decimal  @db.Decimal(10, 2)
  laborCost       Decimal  @db.Decimal(10, 2)
  technicianId    Int?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  ticket        InternalWorkTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  workOrderItem WorkOrderItem?     @relation(fields: [workOrderItemId], references: [id])
  technician    Technician?        @relation(fields: [technicianId], references: [id])

  @@index([ticketId])
  @@index([workOrderItemId])
  @@index([technicianId])
}

model TicketPartEntry {
  id                  String   @id @default(cuid())
  ticketId            String
  workOrderItemId     Int?
  inventoryItemId     String
  quantity            Decimal  @db.Decimal(10, 2)
  unitCost            Decimal  @db.Decimal(10, 2)
  totalCost           Decimal  @db.Decimal(10, 2)
  inventoryMovementId String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  ticket        InternalWorkTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  workOrderItem WorkOrderItem?     @relation(fields: [workOrderItemId], references: [id])
  inventoryItem InventoryItem      @relation(fields: [inventoryItemId], references: [id])

  @@index([ticketId])
  @@index([workOrderItemId])
  @@index([inventoryItemId])
}

// ========================================
// ENUMS
// ========================================

enum InventoryStatus {
  ACTIVE
  LOW_STOCK
  OUT_OF_STOCK
  DISCONTINUED
}

enum MovementType {
  PURCHASE // Compra (entrada)
  CONSUMPTION // Uso en trabajo interno (salida)
  ADJUSTMENT_IN // Ajuste positivo
  ADJUSTMENT_OUT // Ajuste negativo
  TRANSFER_IN // Transferencia entrada
  TRANSFER_OUT // Transferencia salida
  RETURN_SUPPLIER // Devolución a proveedor
  RETURN_STOCK // Devolución a stock
  DAMAGED // Pérdida por daño
  COUNT_ADJUSTMENT // Ajuste por conteo físico
}

enum MovementReferenceType {
  INVOICE // Compra en factura
  INTERNAL_TICKET // Consumo en comprobante
  MANUAL_ADJUSTMENT // Ajuste manual
  TRANSFER // Transferencia
  PHYSICAL_COUNT // Conteo físico
}

enum InternalTicketStatus {
  DRAFT // En edición
  SUBMITTED // Enviado para aprobación
  APPROVED // Aprobado (cierra los items)
  REJECTED // Rechazado
  CANCELLED // Cancelado
}

enum ItemClosureType {
  PENDING // No cerrado
  EXTERNAL_INVOICE // Cerrado con factura
  INTERNAL_TICKET // Cerrado con comprobante interno
  NOT_APPLICABLE // No requiere cierre
}

enum EmploymentType {
  INTERNAL // Empleado de planta
  CONTRACTOR // Contratista
  FREELANCE // Por trabajo
}

// ========================================
// PURCHASE ORDER SYSTEM ENUMS
// ========================================

enum PurchaseOrderType {
  SERVICES // Servicios de mantenimiento
  PARTS // Repuestos y materiales
}

enum PurchaseOrderStatus {
  DRAFT // Borrador, editable
  PENDING_APPROVAL // Enviada a aprobacion
  APPROVED // Aprobada, lista para enviar
  SENT // Enviada al proveedor
  PARTIAL // Parcialmente recibida/facturada
  COMPLETED // Completamente recibida/facturada
  CANCELLED // Cancelada
}

enum POItemStatus {
  PENDING // Pendiente de recibir/facturar
  PARTIAL // Parcialmente recibido
  COMPLETED // Completamente recibido/facturado
  CANCELLED // Cancelado
}

enum WorkType {
  EXTERNAL // Todo va a proveedor externo
  INTERNAL // Todo en taller propio
  MIXED // Algunos items externos, otros internos
}

enum ItemSource {
  EXTERNAL // Compra externa (genera OC)
  INTERNAL_STOCK // Del inventario propio (genera ticket interno)
  INTERNAL_PURCHASE // Compra para uso interno (genera OC + ticket)
}

enum MantItemRequestStatus {
  PENDING // Solicitado, esperando revisión
  APPROVED // Aprobado, MantItem creado
  REJECTED // Rechazado con motivo
}

enum OnboardingStatus {
  PENDING
  PROFILE_COMPLETED
  FLEET_CONFIGURED
  COMPLETED
}
