generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ========================================
// MULTI-TENANCY & BILLING CORE
// ========================================

model Tenant {
  id                String              @id @default(uuid())
  name              String
  slug              String              @unique // Para subdominios
  domain            String?             @unique // Dominio personalizado opcional
  logo              String?
  settings          Json?               // Configuraciones específicas del tenant
  subscriptionId    String?             @unique
  subscriptionStatus SubscriptionStatus @default(TRIAL)
  trialEndsAt       DateTime?
  billingEmail      String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  // Relaciones
  users                       User[]
  vehicles                    Vehicle[]
  vehicleBrands               VehicleBrand[]
  vehicleLines                VehicleLine[]
  vehicleTypes                VehicleType[]
  mantCategories              MantCategory[]
  mantItems                   MantItem[]
  mantPlans                   MantPlan[]
  vehicleMantPlans            VehicleMantPlan[]
  vehicleMantPackages         VehicleMantPackage[]
  maintenanceTemplates        MaintenanceTemplate[]      // NUEVO
  vehicleMaintenanceSchedules VehicleMaintenanceSchedule[] // NUEVO
  workOrders                  WorkOrder[]
  technicians                 Technician[]
  providers                   Provider[]
  documents                   Document[]
  subscriptions               Subscription[]
  drivers                     Driver[]
  vehicleDrivers              VehicleDriver[]

  @@index([slug])
  @@index([subscriptionStatus])
}

model User {
  id        String   @id @default(uuid())
  tenantId  String
  email     String
  firstName String?
  lastName  String?
  role      UserRole @default(USER)
  avatar    String?
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([email])
  @@unique([tenantId, email])
}

// ========================================
// BILLING & SUBSCRIPTIONS
// ========================================

model Subscription {
  id                    String             @id @default(uuid())
  tenantId              String
  mercadoPagoUserId     String?            // ID del usuario en MercadoPago
  preapprovalId         String?            @unique // ID de la suscripción recurrente
  planId                String             // ID del plan de precios
  status                SubscriptionStatus
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  cancelAtPeriodEnd     Boolean            @default(false)
  lastPaymentId         String?            // Último pago procesado
  failedPaymentAttempts Int                @default(0)
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@index([tenantId])
  @@index([mercadoPagoUserId])
  @@index([preapprovalId])
}

model Payment {
  id               String        @id @default(uuid())
  subscriptionId   String
  mercadoPagoId    String        @unique // ID del pago en MercadoPago
  amount           Decimal       @db.Decimal(10, 2)
  currency         String        @default("COP") // Peso colombiano
  status           PaymentStatus
  paymentMethod    String?       // Tarjeta, PSE, etc.
  description      String?
  failureReason    String?
  processedAt      DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([mercadoPagoId])
  @@index([status])
}

// ========================================
// VEHICLE MANAGEMENT
// ========================================

model VehicleBrand {
  id        Int      @id @default(autoincrement())
  tenantId  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  tenant               Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lines                VehicleLine[]
  vehicles             Vehicle[]
  mantPlans            MantPlan[]
  maintenanceTemplates MaintenanceTemplate[] // NUEVO

  @@index([tenantId])
  @@unique([tenantId, name])
}

model VehicleLine {
  id        Int      @id @default(autoincrement())
  tenantId  String
  name      String
  brandId   Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  tenant               Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  brand                VehicleBrand          @relation(fields: [brandId], references: [id], onDelete: Cascade)
  vehicles             Vehicle[]
  mantPlans            MantPlan[]
  maintenanceTemplates MaintenanceTemplate[] // NUEVO

  @@index([tenantId])
  @@index([brandId])
  @@unique([tenantId, brandId, name])
}

model VehicleType {
  id        Int      @id @default(autoincrement())
  tenantId  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vehicles Vehicle[]

  @@index([tenantId])
  @@unique([tenantId, name])
}

model Vehicle {
  id             Int      @id @default(autoincrement())
  tenantId       String
  licensePlate   String
  brandId        Int
  lineId         Int
  typeId         Int
  year           Int
  color          String
  mileage        Int      @default(0)
  status         VehicleStatus @default(ACTIVE)
  situation      VehicleSituation @default(AVAILABLE)
  photo          String?
  cylinder       Int?
  bodyWork       String?
  engineNumber   String?
  chasisNumber   String?
  ownerCard      String?
  owner          VehicleOwner @default(OWN)
  typePlate      PlateType    @default(PARTICULAR)
  lastKilometers Int?
  lastRecorder   DateTime? @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  tenant                    Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  brand                     VehicleBrand               @relation(fields: [brandId], references: [id])
  line                      VehicleLine                @relation(fields: [lineId], references: [id])
  type                      VehicleType                @relation(fields: [typeId], references: [id])
  documents                 Document[]
  workOrders                WorkOrder[]
  odometerLogs              OdometerLog[]
  vehicleMantPlans          VehicleMantPlan[]
  maintenanceAlerts         MaintenanceAlert[]
  vehicleDrivers            VehicleDriver[]
  vehicleMaintenanceSchedule VehicleMaintenanceSchedule? // NUEVO: Un vehículo puede tener un programa

  @@index([tenantId])
  @@index([licensePlate])
  @@index([brandId])
  @@index([lineId])
  @@index([typeId])
  @@unique([tenantId, licensePlate])
}

// ========================================
// MAINTENANCE SYSTEM
// ========================================

model MantCategory {
  id          Int      @id @default(autoincrement())
  tenantId    String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  mantItems MantItem[]

  @@index([tenantId])
  @@unique([tenantId, name])
}

model MantItem {
  id                  Int      @id @default(autoincrement())
  tenantId            String
  name                String
  description         String?
  mantType            MantType
  estimatedTime       Decimal  @db.Decimal(5, 2) // Horas
  estimatedCost       Decimal? @db.Decimal(10, 2) // Costo estimado del item
  categoryId          Int
  status              Status   @default(ACTIVE)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant              Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category            MantCategory          @relation(fields: [categoryId], references: [id])
  planTasks           PlanTask[]
  packageItems        PackageItem[]         // NUEVO: Items que pertenecen a paquetes de template
  workOrderItems      WorkOrderItem[]
  vehicleMantPlanItem VehicleMantPlanItem[]

  @@index([tenantId])
  @@index([categoryId])
  @@unique([tenantId, name])
}

model MantPlan {
  id             Int      @id @default(autoincrement())
  tenantId       String
  name           String
  description    String?
  vehicleBrandId Int
  vehicleLineId  Int
  status         Status   @default(ACTIVE)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  tenant          Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  brand           VehicleBrand      @relation(fields: [vehicleBrandId], references: [id])
  line            VehicleLine       @relation(fields: [vehicleLineId], references: [id])
  planTasks       PlanTask[]
  vehicleMantPlan VehicleMantPlan[]

  @@index([tenantId])
  @@index([vehicleBrandId])
  @@index([vehicleLineId])
  @@unique([tenantId, vehicleBrandId, vehicleLineId, name])
}

model PlanTask {
  id         Int      @id @default(autoincrement())
  planId     Int
  mantItemId Int
  triggerKm  Int      // Cada cuántos km se ejecuta
  createdAt  DateTime @default(now())
  
  mantPlan MantPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  mantItem MantItem @relation(fields: [mantItemId], references: [id])

  @@index([planId])
  @@index([mantItemId])
  @@unique([planId, mantItemId])
}

model VehicleMantPlan {
  id                  Int      @id @default(autoincrement())
  tenantId            String
  vehicleId           Int
  mantPlanId          Int
  assignedAt          DateTime @default(now())
  lastKmCheck         Int?
  status              Status   @default(ACTIVE)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  tenant              Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vehicle             Vehicle               @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  mantPlan            MantPlan              @relation(fields: [mantPlanId], references: [id])
  vehicleMantPlanItem VehicleMantPlanItem[]
  vehicleMantPackages VehicleMantPackage[]  // NUEVO: Paquetes que pertenecen a este plan

  @@index([tenantId])
  @@index([vehicleId])
  @@index([mantPlanId])
  @@unique([vehicleId, mantPlanId])
}

model VehicleMantPlanItem {
  id                Int      @id @default(autoincrement())
  vehicleMantPlanId Int
  mantItemId        Int
  vehicleMantPackageId Int?   // NUEVO: opcional para items que pertenecen a paquetes
  executionMileage  Int      // Km específico en que debe ejecutarse
  technicianId      Int?
  providerId        Int?
  startDate         DateTime?
  endDate           DateTime?
  cost              Decimal? @db.Decimal(10, 2)
  notes             String?
  status            WorkOrderStatus @default(PENDING)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  vehicleMantPlan VehicleMantPlan @relation(fields: [vehicleMantPlanId], references: [id], onDelete: Cascade)
  mantItem        MantItem        @relation(fields: [mantItemId], references: [id])
  technician      Technician?     @relation(fields: [technicianId], references: [id])
  provider        Provider?       @relation(fields: [providerId], references: [id])
  vehicleMantPackage VehicleMantPackage? @relation(fields: [vehicleMantPackageId], references: [id])  // NUEVO: Items pueden pertenecer a un paquete

  @@index([vehicleMantPlanId])
  @@index([mantItemId])
  @@unique([vehicleMantPlanId, mantItemId])
}

model VehicleMantPackage {
  id                    Int      @id @default(autoincrement())
  tenantId              String
  vehicleMantPlanId     Int
  // INFORMACIÓN COPIADA DEL TEMPLATE PACKAGE (independiente)
  packageName           String   // "Mantenimiento 5,000 km" (copiado del MaintenancePackage)
  packageDescription    String?  // Descripción copiada
  originalTriggerKm     Int      // Km original del template (5000, 15000, etc.)
  // KILOMETRAJES ESPECÍFICOS DEL VEHÍCULO
  scheduledExecutionKm  Int      // Km programado REAL para este vehículo (ej: 32000)
  actualExecutionKm     Int?     // Km REAL cuando se ejecutó (null si no ejecutado)
  // MÉTRICAS DE DESVIACIÓN
  deviationKm           Int?     // actualExecutionKm - scheduledExecutionKm
  onTimeExecution       Boolean? // true si a tiempo, false si tarde, null si no ejecutado
  // COSTOS
  estimatedCost         Decimal? @db.Decimal(10, 2) // Costo estimado total del paquete
  actualCost            Decimal? @db.Decimal(10, 2) // Costo real total (suma de items)
  // ESTADO Y TRACKING
  status                WorkOrderStatus @default(PENDING)
  priority              Priority @default(MEDIUM)
  executedAt            DateTime? // Fecha real de ejecución del paquete
  workOrderId           Int?     // WorkOrder generada para este paquete
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // RELACIONES
  tenant              Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vehicleMantPlan     VehicleMantPlan     @relation(fields: [vehicleMantPlanId], references: [id], onDelete: Cascade)
  workOrder           WorkOrder?          @relation(fields: [workOrderId], references: [id])
  vehicleMantPlanItems VehicleMantPlanItem[] // Items que pertenecen a este paquete

  @@index([tenantId])
  @@index([vehicleMantPlanId])
  @@index([scheduledExecutionKm])
  @@index([status])
  @@index([onTimeExecution]) // Para ranking
  @@unique([vehicleMantPlanId, originalTriggerKm]) // No duplicar paquetes del mismo km
}

// ========================================
// MAINTENANCE TEMPLATES & PACKAGES SYSTEM
// ========================================

model MaintenanceTemplate {
  id              Int      @id @default(autoincrement())
  tenantId        String
  name            String   // "Toyota Hilux Standard", "Ford Ranger Heavy Duty"
  description     String?
  vehicleBrandId  Int?     // Opcional: específico para una marca
  vehicleLineId   Int?     // Opcional: específico para una línea
  version         String   @default("1.0") // Para tracking de versiones
  isDefault       Boolean  @default(false) // Template por defecto para esta marca/línea
  status          Status   @default(ACTIVE)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant          Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  brand           VehicleBrand?       @relation(fields: [vehicleBrandId], references: [id])
  line            VehicleLine?        @relation(fields: [vehicleLineId], references: [id])
  packages        MaintenancePackage[]

  @@index([tenantId])
  @@index([vehicleBrandId])
  @@index([vehicleLineId])
  @@index([isDefault])
  @@unique([tenantId, name])
}

model MaintenancePackage {
  id              Int      @id @default(autoincrement())
  templateId      Int
  name            String   // "Mantenimiento 5,000 km", "Mantenimiento 15,000 km"
  triggerKm       Int      // 5000, 15000, 30000, 50000, etc.
  description     String?
  estimatedCost   Decimal? @db.Decimal(10, 2) // Costo estimado total del paquete
  estimatedTime   Decimal? @db.Decimal(5, 2) // Tiempo estimado total en horas
  priority        Priority @default(MEDIUM)
  packageType     MantType @default(PREVENTIVE)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  template        MaintenanceTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  packageItems    PackageItem[]

  @@index([templateId])
  @@index([triggerKm])
  @@unique([templateId, triggerKm]) // Un template no puede tener 2 paquetes para el mismo km
}

model PackageItem {
  id         Int      @id @default(autoincrement())
  packageId  Int
  mantItemId Int
  isOptional Boolean  @default(false) // Si el item es opcional en el paquete
  order      Int      @default(0)     // Orden de ejecución dentro del paquete
  notes      String?  // Notas específicas para este item en este paquete
  createdAt  DateTime @default(now())

  package  MaintenancePackage @relation(fields: [packageId], references: [id], onDelete: Cascade)
  mantItem MantItem           @relation(fields: [mantItemId], references: [id])

  @@index([packageId])
  @@index([mantItemId])
  @@unique([packageId, mantItemId]) // Un paquete no puede tener el mismo item duplicado
}

// ========================================
// VEHICLE-SPECIFIC MAINTENANCE PROGRAMS
// ========================================

model VehicleMaintenanceSchedule {
  id                    Int      @id @default(autoincrement())
  tenantId              String
  vehicleId             Int

  // INFORMACIÓN DE ORIGEN (solo referencial - NO referencia FK)
  generatedFrom         String?  // "Template: Toyota Hilux Standard v1.2"
  generatedAt           DateTime @default(now())
  generatedBy           String   // User ID quien generó el programa

  // KILOMETRAJE INICIAL AL MOMENTO DE CREAR PROGRAMA
  assignmentKm          Int      // Km del vehículo cuando se asignó el programa
  nextMaintenanceKm     Int      // Próximo vencimiento REAL conocido por usuario
  nextMaintenanceDesc   String?  // "Cambio aceite 30,000 km" - descripción del próximo

  // MÉTRICAS DE DESVIACIÓN PARA RANKING
  totalMaintenances     Int      @default(0)     // Cantidad total de mantenimientos completados
  avgDeviationKm        Int      @default(0)     // Desviación promedio (+ tarde, - temprano)
  maintenanceScore      Int      @default(100)   // Score 0-100 para ranking (100 = perfecto)
  lastScoreUpdate       DateTime @default(now()) // Última actualización del score

  // CONFIGURACIÓN
  alertOffsetKm         Int      @default(1000)  // Alertar X km antes del vencimiento
  isActive              Boolean  @default(true)  // Programa activo o pausado
  notes                 String?  // Notas del usuario sobre este programa

  status                Status   @default(ACTIVE)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  tenant                Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vehicle               Vehicle              @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  scheduledPackages     ScheduledPackage[]

  @@unique([vehicleId])   // Un vehículo solo puede tener un programa activo
  @@index([tenantId])
  @@index([maintenanceScore]) // Para ranking
  @@index([avgDeviationKm])   // Para análisis de patrones
}

model ScheduledPackage {
  id                    Int      @id @default(autoincrement())
  scheduleId            Int

  // INFORMACIÓN DEL PAQUETE (copiada independientemente)
  packageName           String   // "Mantenimiento 15,000 km" (copiado del template)
  packageDescription    String?  // Descripción copiada

  // KILOMETRAJES - La clave del sistema
  idealExecutionKm      Int      // Km ideal según template original (15000, 30000, etc.)
  scheduledExecutionKm  Int      // Km programado REAL para este vehículo específico
  actualExecutionKm     Int?     // Km REAL cuando se ejecutó (null si no ejecutado)

  // DESVIACIÓN Y MÉTRICAS PARA RANKING
  deviationKm           Int?     // actualExecutionKm - scheduledExecutionKm (calculado al completar)
  onTimeExecution       Boolean? // true si se hizo a tiempo, false si tarde, null si no ejecutado

  // COSTOS
  estimatedCost         Decimal? @db.Decimal(10, 2) // Costo estimado del paquete
  actualCost            Decimal? @db.Decimal(10, 2) // Costo real (suma de WorkOrderExpenses)

  // ESTADO Y TRACKING
  status                ScheduleStatus @default(SCHEDULED)
  workOrderId           Int?     // WorkOrder generada para este paquete (cuando se ejecuta)
  executedAt            DateTime? // Fecha real de ejecución
  alertLevel            AlertLevel @default(LOW) // Nivel de alerta actual

  // AUDITORÍA
  adjustedBy            String?  // User ID o "SYSTEM_AUTO" si fue ajuste automático
  adjustmentReason      String?  // Razón del ajuste de programación
  lastAlertSent         DateTime? // Última alerta enviada

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  schedule              VehicleMaintenanceSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  workOrder             WorkOrder?                 @relation(fields: [workOrderId], references: [id])

  @@index([scheduleId])
  @@index([scheduledExecutionKm])
  @@index([alertLevel])
  @@index([deviationKm])        // Para análisis de patrones
  @@index([onTimeExecution])    // Para ranking
}

// ========================================
// WORK ORDERS (EXTENDIDO)
// ========================================

model WorkOrder {
  id              Int      @id @default(autoincrement())
  tenantId        String
  vehicleId       Int
  title           String
  description     String?
  mantType        MantType
  priority        Priority
  status          WorkOrderStatus @default(PENDING)
  technicianId    Int?
  providerId      Int?
  creationMileage Int

  // CONEXIÓN CON PAQUETES DE MANTENIMIENTO
  isPackageWork   Boolean         @default(false) // true si es WorkOrder de paquete completo
  packageName     String?         // Nombre del paquete si aplica
  scheduledPackageId Int?         // Referencia al ScheduledPackage que generó esta WorkOrder

  // Campos de trazabilidad financiera
  requestedBy     String          // User ID solicitante
  authorizedBy    String?         // User ID autorizador
  estimatedCost   Decimal?        @db.Decimal(10, 2) // Costo estimado
  actualCost      Decimal?        @db.Decimal(10, 2) // Costo real final
  costCenter      String?         // Centro de costos
  budgetCode      String?         // Código presupuestario

  // Campos legacy (mantener compatibilidad)
  plannedAmount   Decimal?        @db.Decimal(10, 2)
  realAmount      Decimal?        @db.Decimal(10, 2)

  startDate       DateTime?
  endDate         DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  tenant            Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vehicle           Vehicle            @relation(fields: [vehicleId], references: [id])
  technician        Technician?        @relation(fields: [technicianId], references: [id])
  provider          Provider?          @relation(fields: [providerId], references: [id])
  workOrderItems    WorkOrderItem[]
  workOrderExpenses WorkOrderExpense[]
  approvals         WorkOrderApproval[]
  auditLogs         ExpenseAuditLog[]
  scheduledPackages ScheduledPackage[] // Paquetes que generaron esta WorkOrder
  vehicleMantPackages VehicleMantPackage[] // NUEVO: Paquetes del nuevo sistema

  @@index([tenantId])
  @@index([vehicleId])
  @@index([status])
  @@index([requestedBy])
  @@index([authorizedBy])
  @@index([isPackageWork]) // Para separar WorkOrders de paquetes vs individuales
}

model WorkOrderItem {
  id               Int      @id @default(autoincrement())
  workOrderId      Int
  mantItemId       Int

  // Detalles del item/repuesto
  description      String
  partNumber       String?
  brand            String?
  supplier         String

  // Costos detallados
  unitPrice        Decimal  @db.Decimal(10, 2)
  quantity         Int      @default(1)
  totalCost        Decimal  @db.Decimal(10, 2)

  // Trazabilidad
  purchasedBy      String   // User ID quien compró
  invoiceNumber    String?
  receiptUrl       String?  // URL del recibo escaneado

  // Campos legacy
  cost             Decimal? @db.Decimal(10, 2)
  executionMileage Int?
  notes            String?
  status           WorkOrderStatus @default(PENDING)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  mantItem  MantItem  @relation(fields: [mantItemId], references: [id])

  @@index([workOrderId])
  @@index([mantItemId])
  @@index([supplier])
  @@index([purchasedBy])
}

model WorkOrderExpense {
  id            String         @id @default(cuid())
  workOrderId   Int
  expenseType   ExpenseType
  description   String
  amount        Decimal        @db.Decimal(10, 2)
  vendor        String         // Proveedor/Taller
  invoiceNumber String?
  receiptUrl    String?        // URL del recibo escaneado
  expenseDate   DateTime       @default(now())
  recordedBy    String         // User ID quien registró
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@index([expenseType])
  @@index([vendor])
  @@index([recordedBy])
}

model WorkOrderApproval {
  id            String              @id @default(cuid())
  workOrderId   Int
  approverLevel Int                 // 1=supervisor, 2=manager, 3=admin
  approvedBy    String              // User ID
  approvedAt    DateTime            @default(now())
  amount        Decimal             @db.Decimal(10, 2)
  notes         String?
  status        ApprovalStatus      @default(PENDING)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@index([approverLevel])
  @@index([approvedBy])
  @@index([status])
}

model ExpenseAuditLog {
  id              String      @id @default(cuid())
  workOrderId     Int
  action          AuditAction // CREATED, APPROVED, MODIFIED, PAID
  previousValue   Json?
  newValue        Json
  performedBy     String      // User ID
  performedAt     DateTime    @default(now())
  ipAddress       String?
  userAgent       String?     // Para mejor trazabilidad
  createdAt       DateTime    @default(now())

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@index([performedBy])
  @@index([performedAt])
}

// ========================================
// PEOPLE & PROVIDERS
// ========================================

model Technician {
  id                  Int                   @id @default(autoincrement())
  tenantId            String
  name                String
  email               String?
  phone               String?
  specialty           TechnicianSpecialty?
  status              Status                @default(ACTIVE)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  
  tenant              Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workOrders          WorkOrder[]
  vehicleMantPlanItem VehicleMantPlanItem[]

  @@index([tenantId])
  @@unique([tenantId, name])
}

model Provider {
  id                  Int                 @id @default(autoincrement())
  tenantId            String
  name                String
  email               String?
  phone               String?
  address             String?
  specialty           ProviderSpecialty?
  status              Status              @default(ACTIVE)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  
  tenant              Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workOrders          WorkOrder[]
  vehicleMantPlanItem VehicleMantPlanItem[]

  @@index([tenantId])
  @@unique([tenantId, name])
}

model Driver {
  id            Int      @id @default(autoincrement())
  tenantId      String
  name          String
  email         String?
  phone         String?
  licenseNumber String?
  licenseExpiry DateTime?
  status        Status   @default(ACTIVE)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  odometerLogs   OdometerLog[]
  vehicleDrivers VehicleDriver[]

  @@index([tenantId])
  @@unique([tenantId, licenseNumber])
}

model VehicleDriver {
  id         Int      @id @default(autoincrement())
  tenantId   String   // Multi-tenant support
  vehicleId  Int
  driverId   Int
  status     Status   @default(ACTIVE) // ACTIVE/INACTIVE
  isPrimary  Boolean  @default(false)  // Conductor principal del vehículo
  startDate  DateTime @default(now())  // Fecha inicio de asignación
  endDate    DateTime?                 // Fecha fin de asignación (opcional)
  notes      String?                   // Notas sobre la asignación
  assignedBy String?                   // ID del usuario que asignó
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  driver  Driver  @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@unique([tenantId, vehicleId, driverId]) // No duplicados por tenant
  @@index([tenantId])
  @@index([vehicleId])
  @@index([driverId])
  @@index([status])
  @@index([startDate])
}

// ========================================
// MONITORING & ALERTS
// ========================================

model OdometerLog {
  id           Int                   @id @default(autoincrement())
  vehicleId    Int
  driverId     Int?
  kilometers   Int?
  hours        Int?
  measureType  OdometerMeasureType   @default(KILOMETERS)
  recordedAt   DateTime              @default(now())
  createdAt    DateTime              @default(now())
  
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  driver  Driver? @relation(fields: [driverId], references: [id])

  @@index([vehicleId])
  @@index([driverId])
  @@index([recordedAt])
}

model MaintenanceAlert {
  id                  Int        @id @default(autoincrement())
  vehicleId           Int
  mantItemDescription String
  currentKm           Int
  executionKm         Int
  kmToMaintenance     Int
  alertLevel          AlertLevel
  status              Status     @default(ACTIVE)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
  
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([alertLevel])
  @@index([status])
}

model Document {
  id           String         @id @default(uuid())
  tenantId     String
  vehicleId    Int
  type         DocumentType
  fileName     String
  fileUrl      String
  expiryDate   DateTime?
  status       DocumentStatus @default(ACTIVE)
  uploadedAt   DateTime       @default(now())
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([vehicleId])
  @@index([type])
  @@index([expiryDate])
}

// ========================================
// ENUMS
// ========================================

enum UserRole {
  ADMIN
  MANAGER
  USER
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PENDING_PAYMENT
  PAST_DUE
  CANCELED
  INCOMPLETE
}

enum PaymentStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  REFUNDED
  IN_PROCESS
}

enum VehicleStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
  SOLD
}

enum VehicleSituation {
  AVAILABLE
  IN_USE
  MAINTENANCE
}

enum VehicleOwner {
  OWN
  LEASED
  RENTED
}

enum PlateType {
  PARTICULAR
  PUBLICO
}

enum Status {
  ACTIVE
  INACTIVE
}

enum MantType {
  PREVENTIVE
  PREDICTIVE
  CORRECTIVE
  EMERGENCY
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum WorkOrderStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ExpenseType {
  PARTS
  LABOR
  TRANSPORT
  TOOLS
  MATERIALS
  OTHER
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum AuditAction {
  CREATED
  APPROVED
  REJECTED
  MODIFIED
  PAID
  CANCELLED
  COMPLETED
}

enum AlertLevel {
  LOW      // > 1000 km
  MEDIUM   // 500-1000 km  
  HIGH     // < 500 km
  CRITICAL // Vencido
}

enum DocumentType {
  SOAT
  TECNOMECANICA
  INSURANCE
  REGISTRATION
  OTHER
}

enum DocumentStatus {
  ACTIVE
  EXPIRED
  EXPIRING_SOON
}

enum OdometerMeasureType {
  KILOMETERS
  HOURS
}

enum TechnicianSpecialty {
  MOTOR
  TRANSMISION
  FRENOS
  SUSPENSION
  ELECTRICO
  ELECTRONICO
  AIRE_ACONDICIONADO
  PINTURA
  CARROCERIA
  SOLDADURA
  GENERAL
}

enum ProviderSpecialty {
  REPUESTOS
  LUBRICANTES
  NEUMATICOS
  BATERIAS
  FILTROS
  FRENOS
  SUSPENSION
  ELECTRICO
  PINTURA
  CARROCERIA
  SOLDADURA
  SERVICIOS_GENERALES
  GRUA
  SEGUROS
}

enum ScheduleStatus {
  SCHEDULED    // Programado, esperando llegar al kilometraje
  DUE          // Vencido, debe hacerse ya
  OVERDUE      // Atrasado, debería haberse hecho
  IN_PROGRESS  // En ejecución (WorkOrder creada)
  COMPLETED    // Completado exitosamente
  SKIPPED      // Saltado/omitido por el usuario
  CANCELLED    // Cancelado
}